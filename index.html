<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    
    <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self'; 
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; 
                 script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://*.googleapis.com https://*.firebaseio.com https://*.firebasedatabase.app https://*.jsdelivr.net; 
                 connect-src 'self' https://www.gstatic.com https://*.googleapis.com https://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebaseio.com wss://*.firebasedatabase.app https://*.jsdelivr.net;
                 img-src 'self' data: https://vienkiemsat.cantho.gov.vn https://upload.wikimedia.org blob:;">

    <title>Phần Mềm Quản Lý Đơn Khiếu nại - Tố Cáo</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    
    <style>
        
        body {
            font-family: 'Segoe UI', 'Times New Roman', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
        }

        header {
            width: 100%;
            padding: 20px;
            background-color: #004d40;
            color: white;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        
        #login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #E6F7FF; /* Xanh dương nhạt */
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            margin: auto;
            position: absolute;
            top: 55%; /* Tăng từ 50% lên 55% */
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #login-container h2 {
            margin-bottom: 20px;
            color: #D32F2F; /* Đỏ */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        #login-container input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        #login-container button {
            width: 100%;
            padding: 12px;
            background-color: #004d40;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        #login-container button:hover {
            background-color: #00332b;
        }

        #main-container {
            display: none;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            margin-top: 20px;
        }
        
        .main-content {
            display: flex;
            flex-direction: row;
            width: 100%;
            height: calc(100% - 60px);
            gap: 20px;
            padding: 0 20px;
        }
        
        .sidebar {
            flex: 1;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .main-panel {
            flex: 2;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
        }
        
        .sidebar button, .main-panel button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            color: white;
            background-color: #00796b;
            transition: background-color 0.3s;
        }

        .sidebar button:hover, .main-panel button:hover {
            background-color: #00605a;
        }
        
        .form-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-section.full-width {
            grid-template-columns: 1fr;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: span 2;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
            background-color: #f9f9f9;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .can-cu-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 2fr auto;
            gap: 10px;
            margin-bottom: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: #e0f2f1;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f5f5f5;
        }
        
        tr:hover {
            background-color: #e8f5e9;
        }
        
        .table-actions button {
            padding: 5px 10px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .table-actions td {
            white-space: nowrap;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

         .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 600px; 
            width: 90%;
            position: relative;
            max-height: 90vh; 
            overflow-y: auto; 
        }

      
        .modal-content.large-modal {
            max-width: 90%; 
            max-width: 1200px; 
        }
        
        
        #accountsModal .modal-content {
            max-width: 700px; 
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }
        
        .close-btn:hover, .close-btn:focus {
            color: #000;
        }
        
        .btn-container {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .delete-btn {
            background-color: #d32f2f !important;
        }
        
        .delete-btn:hover {
            background-color: #b71c1c !important;
        }
        
        .edit-btn {
            background-color: #1976d2 !important;
        }
        
        .edit-btn:hover {
            background-color: #1565c0 !important;
        }
        
        .xu-ly-btn {
            background-color: #00897b !important;
        }
        
        .export-proposal-btn {
            background-color: #3f51b5 !important;
        }
        
        .export-proposal-btn:hover {
            background-color: #303f9f !important;
        }
        
      
        #proposal-content {
            white-space: pre-wrap;
            font-family: 'Times New Roman', serif;
            font-size: 14pt; 
            line-height: 1.5;
        }
        
        #top-right-buttons {
            position: absolute;
            top: 10px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        #account-list li {
            list-style: none;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #account-list li button {
             margin-left: 10px;
             padding: 5px 10px;
             font-size: 12px;
             width: auto;
        }
        .reset-btn {
             background-color: #ff9800 !important;
        }
        .reset-btn:hover {
             background-color: #fb8c00 !important;
        }
    </style>
</head>
<body>
    <header>
        <h1>VIỆN KIỂM SÁT NHÂN DÂN THÀNH PHỐ CẦN THƠ</h1>
        <H2>QUẢN LÝ ĐƠN KHIẾU NẠI - TỐ CÁO</H2>
        <div id="top-right-buttons">
            <button id="account-btn" onclick="showAccountsModal()">Quản lý tài khoản</button>
            <button onclick="showChangePassModal()">Đổi mật khẩu</button> 
            <button onclick="logout()">Đăng xuất</button>
        </div>
    </header>

    <div id="login-container">
        <img src="https://vienkiemsat.cantho.gov.vn/files/images/logo-vks.png" 
             alt="Logo Viện Kiểm Sát" style="width: 100px; margin-bottom: 20px;">
        <h2>Đăng Nhập</h2>
        <input type="text" id="username" placeholder="Tên đăng nhập">
        <input type="password" id="password" placeholder="Mật khẩu">
        <button onclick="login()">Đăng Nhập</button>
        <p><a href="#" onclick="handleForgotPassword()">Quên mật khẩu?</a></p>
    </div>

    <div id="main-container">
        <div class="main-content">
            <div class="sidebar">
                <h2>Lưu đơn mới</h2>
                <div class="form-section">
                    <div class="form-group">
                        <label for="ngay_nhan">Ngày nhận đơn:</label>
                        <input type="date" id="ngay_nhan">
                    </div>
                    <div class="form-group">
                        <label for="nguon_don">Nguồn đơn:</label>
                        <select id="nguon_don"></select>
                    </div>
                </div>
                <div class="form-section full-width">
                    <div class="form-group">
                        <label for="ho_ten">Họ tên/Cơ quan/Tổ chức:</label>
                        <input type="text" id="ho_ten">
                    </div>
                    <div class="form-group">
                        <label for="dia_chi">Địa chỉ:</label>
                        <input type="text" id="dia_chi">
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-group">
                        <label for="ngay_ghi">Đơn ghi ngày:</label>
                        <input type="date" id="ngay_ghi">
                    </div>
                    <div class="form-group">
                        <label for="phan_loai">Phân loại:</label>
                        <select id="phan_loai" onchange="capNhatThamQuyenMacDinh()">
                            <option value="Khiếu nại">Khiếu nại</option>
                            <option value="Tố cáo">Tố cáo</option>
                            <option value="Kiến nghị/Phản ánh/Khác">Kiến nghị/Phản ánh/Khác</option>
                            <option value="Yêu cầu bồi thường thiệt hại">Yêu cầu bồi thường thiệt hại</option> 
                            <option value="Đề nghị KN, GĐT, TT">Đề nghị KN, GĐT, TT</option>
                            <option value="Đề nghị kiểm tra QĐGQKN">Đề nghị kiểm tra QĐGQKN</option>
                            <option value="Tin báo/Tố giác tội phạm trong HĐTP">Tin báo/Tố giác tội phạm trong HĐTP</option>
                        </select>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-group">
                        <label for="tham_quyen">Thẩm quyền:</label>
                        <select id="tham_quyen">
                            <option value="Chọn">--Chọn--</option>
                            <option value="Thuộc thẩm quyền giải quyết">Thuộc thẩm quyền giải quyết</option>
                            <option value="Thuộc thẩm quyền kiểm sát">Thuộc thẩm quyền kiểm sát</option>
                            <option value="Không thuộc thẩm quyền">Không thuộc thẩm quyền</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="can_bo_phan_cong">Cán bộ phân công:</label>
                        <input type="text" id="can_bo_phan_cong" readonly>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-group">
                        <label for="chuc_danh">Chức danh:</label>
                        <select id="chuc_danh">
                            <option value="Chọn">--Chọn--</option>
                            <option value="Kiểm sát viên trung cấp">Kiểm sát viên trung cấp</option>
                            <option value="Kiểm sát viên sơ cấp">Kiểm sát viên sơ cấp</option>
                            <option value="Kiểm tra viên chính">Kiểm tra viên chính</option>
                            <option value="Kiểm tra viên">Kiểm tra viên</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="chuyen_den">Chuyển đến:</label>
                        <select id="chuyen_den"></select>
                    </div>
                </div>
                <div class="form-section">
                     <div class="form-group">
                        <label for="ngay_chuyen_don">Ngày chuyển đơn:</label>
                        <input type="date" id="ngay_chuyen_don">
                    </div>
                </div>
                <div class="form-group full-width">
                    <label>Căn cứ:</label>
                    <div id="can_cu_container"></div>
                    <button onclick="addCanCu()">Thêm căn cứ</button>
                </div>
                <div class="form-group full-width">
                    <label for="noi_dung">Nội dung đơn:</label>
                    <textarea id="noi_dung"></textarea>
                </div>
                <div class="form-group full-width">
                    <label for="de_xuat">Đề xuất:</label>
                    <textarea id="de_xuat"></textarea>
                </div>
                <div class="form-group full-width">
                    <label for="ket_qua">Kết quả:</label>
                    <textarea id="ket_qua"></textarea>
                </div>
                <input type="hidden" id="edit-id">
                <button onclick="saveDon()">Lưu đơn</button>
            </div>

            <div class="main-panel">
                <h2>Danh sách đơn</h2>
                <div class="btn-container" style="justify-content: flex-start; margin-bottom: 20px;">
                    <button onclick="exportList()">Xuất Danh sách đơn</button>
                    <button onclick="exportReport()">Xuất báo cáo</button>
                    <button onclick="downloadJSON()">Sao lưu JSON</button>
                    <button class="export-btn" onclick="downloadResolutionResultDoc(currentSelectedId)">Trích xuất kết quả xử lý đơn</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Ngày nhận đơn</th>
                            <th>Họ tên /CQ/ TC</th>
                            <th>Nội dung đơn</th>
                            <th>Phân loại</th>
                            <th>Thẩm quyền</th>
                            <th>Xử lý đơn</th> 
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="don-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="accountsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('accountsModal').style.display='none'">&times;</span>
            <h3>Quản lý Tài khoản</h3>
            <h4>Tạo tài khoản mới</h4>
            <div class="form-section">
                <div class="form-group">
                    <label for="new-username">Tên đăng nhập:</label>
                    <input type="text" id="new-username">
                </div>
                <div class="form-group">
                    <label for="new-password">Mật khẩu:</label>
                    <input type="password" id="new-password">
                </div>
                <div class="form-group">
                    <label for="new-role">Vai trò:</label>
                    <select id="new-role">
                        <option value="admin">Quản trị viên (admin)</option>
                        <option value="manager_TP">Quản lý cấp Thành phố</option>
                        <option value="user_TP">Người dùng cấp Thành phố</option>
                        <option value="manager_KV">Quản lý cấp Khu vực</option>
                        <option value="user_KV">Người dùng cấp Khu vực</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-unit">Đơn vị:</label>
                    <select id="new-unit"></select>
                </div>
            </div>
            <button onclick="createAccount()">Tạo tài khoản</button>
            <h4>Danh sách tài khoản</h4>
            <ul id="account-list"></ul>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content large-modal">
            <span class="close-btn" onclick="document.getElementById('editModal').style.display='none'">&times;</span>
            <h3>Sửa đổi đơn</h3>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-ngay_nhan">Ngày nhận đơn:</label>
                    <input type="date" id="sua-ngay_nhan">
                </div>
                <div class="form-group">
                    <label for="sua-nguon_don">Nguồn đơn:</label>
                    <select id="sua-nguon_don"></select>
                </div>
            </div>
            <div class="form-section full-width">
                <div class="form-group">
                    <label for="sua-ho_ten">Họ tên/Cơ quan/Tổ chức:</label>
                    <input type="text" id="sua-ho_ten">
                </div>
                <div class="form-group">
                    <label for="sua-dia_chi">Địa chỉ:</label>
                    <input type="text" id="sua-dia_chi">
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-ngay_ghi">Đơn ghi ngày:</label>
                    <input type="date" id="sua-ngay_ghi">
                </div>
                <div class="form-group">
                    <label for="sua-phan_loai">Phân loại:</label>
                    <select id="sua-phan_loai" onchange="capNhatThamQuyenMacDinh('sua-')">
                            <option value="Chọn">--Chọn--</option>
                            <option value="Khiếu nại">Khiếu nại</option>
                            <option value="Tố cáo">Tố cáo</option>
                            <option value="Kiến nghị/Phản ánh/Khác">Kiến nghị/Phản ánh/Khác</option>
                            <option value="Yêu cầu bồi thường thiệt hại">Yêu cầu bồi thường thiệt hại</option> 
                            <option value="Đề nghị KN, GĐT, TT">Đề nghị KN, GĐT, TT</option>
                            <option value="Đề nghị kiểm tra QĐGQKN">Đề nghị kiểm tra QĐGQKN</option>
                            <option value="Tin báo/Tố giác tội phạm trong HĐTP">Tin báo/Tố giác tội phạm trong HĐTP</option>
                    </select>
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-tham_quyen">Thẩm quyền:</label>
                    <select id="sua-tham_quyen">
                        <option value="Chọn">--Chọn--</option>
                        <option value="Thuộc thẩm quyền giải quyết">Thuộc thẩm quyền giải quyết</option>
                        <option value="Thuộc thẩm quyền kiểm sát">Thuộc thẩm quyền kiểm sát</option>
                        <option value="Không thuộc thẩm quyền">Không thuộc thẩm quyền</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sua-can_bo_phan_cong">Cán bộ phân công:</label>
                    <input type="text" id="sua-can_bo_phan_cong">
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-chuc_danh">Chức danh:</label>
                    <select id="sua-chuc_danh">
                        <option value="Chọn">--Chọn--</option>
                        <option value="Kiểm sát viên trung cấp">Kiểm sát viên trung cấp</option>
                        <option value="Kiểm sát viên sơ cấp">Kiểm sát viên sơ cấp</option>
                        <option value="Kiểm tra viên chính">Kiểm tra viên chính</option>
                        <option value="Kiểm tra viên">Kiểm tra viên</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sua-chuyen_den">Chuyển đến:</label>
                    <select id="sua-chuyen_den"></select>
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-ngay_chuyen_don">Ngày chuyển đơn:</label>
                    <input type="date" id="sua-ngay_chuyen_don">
                </div>
            </div>
             <div class="form-group full-width">
                <label>Căn cứ:</label>
                <div id="sua-can_cu_container"></div>
                <button onclick="addCanCu('sua-')">Thêm căn cứ</button>
            </div>
            <div class="form-group full-width">
                <label for="sua-noi_dung">Nội dung đơn:</label>
                <textarea id="sua-noi_dung"></textarea>
            </div>
            <div class="form-group full-width">
                <label for="sua-de_xuat">Đề xuất:</label>
                <textarea id="sua-de_xuat"></textarea>
            </div>
            <div class="form-group full-width">
                <label for="sua-ket_qua">Kết quả:</label>
                <textarea id="sua-ket_qua"></textarea>
            </div>
            <input type="hidden" id="edit-id-modal"> 
            <div class="btn-container">
                <button onclick="updateDon()">Cập nhật</button>
            </div>
        </div>
    </div>
    
    <div id="proposalModal" class="modal">
        <div class="modal-content large-modal">
            <span class="close-btn" onclick="document.getElementById('proposalModal').style.display='none'">&times;</span>
            <pre id="proposal-content"></pre>
            <div class="btn-container">
                <button onclick="downloadProposalDoc()">Tải xuống file word</button>
            </div>
        </div>
    </div>

    <div id="changePassModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('changePassModal').style.display='none'">&times;</span>
            <h3>Đổi mật khẩu</h3>
            <div class="form-group">
                <label for="old-password">Mật khẩu cũ:</label>
                <input type="password" id="old-password">
            </div>
            <div class="form-group">
                <label for="new-password-change">Mật khẩu mới:</label>
                <input type="password" id="new-password-change">
            </div>
            <div class="form-group">
                <label for="confirm-password-change">Xác nhận mật khẩu mới:</label>
                <input type="password" id="confirm-password-change">
            </div>
            <div class="btn-container">
                <button onclick="changePassword()">Xác nhận</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE CONFIGURATION & INITIALIZATION (PHẢI THAY THẾ) ---
        // THAY THẾ CHỖ NÀY BẰNG CẤU HÌNH CỦA BẠN
        const firebaseConfig = {
            apiKey: "AIzaSyBvhrOBoJc9-gKuTAXDlPknVdxKecgPH_g",
            authDomain: "quanlydonvks-d7ff9.firebaseapp.com",
            databaseURL: "https://quanlydonvks-d7ff9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "quanlydonvks-d7ff9",
            storageBucket: "quanlydonvks-d7ff9.firebasestorage.app",
            messagingSenderId: "209768483000",
            appId: "1:209768483000:web:1eb449ad41840e23334c4d"
        };
        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- GLOBAL DATA & INITIALIZATION ---
        let accounts = {}; // Dữ liệu tài khoản (tải từ Firebase)
        let dons = []; // Dữ liệu đơn (tải từ Firebase dưới dạng mảng để dễ xử lý)
        let currentUser = null; 
        
        // Dữ liệu danh mục
        const lookupData = {
            'Nguồn đơn': [
               'Bưu điện', 'Tiếp công dân', 'Các cơ quan Đảng, Nhà nước', 'UBND TPCT',
                'Cục Điều tra, VKSTC', 'V11, VKSTC', 'V12, VKSTC', 'Các Sở, Ban, Ngành', 'Thành ủy'
            ],
            'Chuyển đến': [
                'Lưu đơn', 'Trả đơn', 'Thông báo chỉ dẫn',
                'THADS TP.CT', 'THADS KV1','THADS KV2','THADS KV3','THADS KV4','THADS KV5','THADS KV6','THADS KV7',
                'THADS KV8','THADS KV9','THADS KV10','THADS KV11','THADS KV12','THADS KV13','THADS KV14',
                'TAND TP.CT', 'TAND KV1', 'TAND KV2','TAND KV3','TAND KV4','TAND KV5','TAND KV6','TAND KV7',
                'TAND KV8','TAND KV9','TAND KV10','TAND KV11','TAND KV12','TAND KV13','TAND KV14',
                'CQCSĐT TP.CT', 'Công an phường', 
                'VKSND KV1',  'VKSND KV2', 'VKSND KV3', 'VKSND KV4', 'VKSND KV5', 'VKSND KV6', 'VKSND KV7',
                'VKSND KV8', 'VKSND KV9', 'VKSND KV10', 'VKSND KV11', 'VKSND KV12', 'VKSND KV13', 'VKSND KV14',
                'Phòng 1', 'Phòng 2', 'Phòng 7', 'Phòng 8', 'Phòng 9', 'Phòng 10', 'Phòng 11', 'Phòng 15'
            ],
            'Đơn vị': [
                'TT-KT',  'VKSND KV1',  'VKSND KV2', 'VKSND KV3', 'VKSND KV4', 'VKSND KV5', 'VKSND KV6', 'VKSND KV7',
                'VKSND KV8', 'VKSND KV9', 'VKSND KV10', 'VKSND KV11', 'VKSND KV12', 'VKSND KV13', 'VKSND KV14'
            ]
        };
        
        // --- AUTHENTICATION FUNCTIONS ---
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            database.ref('accounts').once('value')
                .then(snapshot => {
                    const accounts = snapshot.val() || {};
                    if (accounts[username] && accounts[username].password === password) {
                        currentUser = { username: username, role: accounts[username].role, unit: accounts[username].unit };
                        document.getElementById('login-container').style.display = 'none';
                        document.getElementById('main-container').style.display = 'flex';
                        document.getElementById('can_bo_phan_cong').value = currentUser.username;
                        
                        if (currentUser.role === 'admin' || currentUser.role === 'super_admin') {
                            document.getElementById('account-btn').style.display = 'block';
                        } else {
                            document.getElementById('account-btn').style.display = 'none';
                        }
                        
                        updateTable();
                    } else {
                        alert('Tên đăng nhập hoặc mật khẩu không đúng!');
                    }
                })
                .catch(error => {
                    alert('Lỗi khi đăng nhập: ' + error.message);
                });
        }
        function logout() {
            currentUser = null;
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('main-container').style.display = 'none';
            document.getElementById('account-btn').style.display = 'none';
        }
        
        function showChangePassModal() {
            if (!currentUser) {
                alert('Vui lòng đăng nhập trước.');
                return;
            }
            document.getElementById('old-password').value = '';
            document.getElementById('new-password-change').value = '';
            document.getElementById('confirm-password-change').value = '';
            document.getElementById('changePassModal').style.display = 'flex';
        }

        function changePassword() {
            const oldPass = document.getElementById('old-password').value;
            const newPass = document.getElementById('new-password-change').value;
            const confirmPass = document.getElementById('confirm-password-change').value;

            if (!currentUser) return alert('Vui lòng đăng nhập trước.');
            
            database.ref('accounts/' + currentUser.username).once('value').then(snap => {
                const currentAccount = snap.val();
                
                if (!currentAccount) return alert('Lỗi: Không tìm thấy thông tin tài khoản.');

                if (oldPass === currentAccount.password) {
                    if (newPass === confirmPass) {
                         if (newPass.length < 3) {
                             alert('Mật khẩu mới phải có ít nhất 3 ký tự.');
                             return;
                         }
                        database.ref('accounts/' + currentUser.username + '/password').set(newPass)
                            .then(() => {
                                alert('Mật khẩu đã được thay đổi thành công!');
                                document.getElementById('changePassModal').style.display = 'none';
                                accounts[currentUser.username].password = newPass;
                            }).catch(error => {
                                alert('Lỗi khi đổi mật khẩu: ' + error.message);
                            });
                    } else {
                        alert('Mật khẩu mới không khớp.');
                    }
                } else {
                    alert('Mật khẩu cũ không đúng.');
                }
            }).catch(error => {
                alert('Lỗi khi kiểm tra mật khẩu: ' + error.message);
            });
        }
        
        function handleForgotPassword() {
            const username = prompt('Vui lòng nhập tên đăng nhập của bạn:');
            if (!username) return;

            database.ref('accounts/' + username).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                         if (confirm('Hệ thống sẽ đặt lại mật khẩu của bạn về "123". Vui lòng đăng nhập và đổi lại mật khẩu.')) {
                            database.ref('accounts/' + username + '/password').set('123')
                                .then(() => {
                                    alert('Đã đặt lại mật khẩu thành công!');
                                }).catch(error => {
                                    alert('Lỗi khi đặt lại mật khẩu: ' + error.message);
                                });
                         }
                    } else {
                        alert('Tên đăng nhập không tồn tại.');
                    }
                })
                .catch(error => {
                    alert('Lỗi khi kiểm tra tài khoản: ' + error.message);
                });
        }
        function initializeDefaultAccounts() {
            database.ref('accounts').once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    const defaultAccounts = {
                        "adminct": { "password": "123", "role": "admin", "unit": "Thành phố" },
                        "quanlyTP": { "password": "123", "role": "manager_TP", "unit": "Thành phố" },
                        "userTP": { "password": "123", "role": "user_TP", "unit": "Thành phố" }
                    };
                    database.ref('accounts').set(defaultAccounts)
                        .catch(error => console.error("Lỗi khi tạo tài khoản mặc định:", error));
                }
            });
            database.ref('accounts').on('value', snap => {
                accounts = snap.val() || {};
            });
        }
        // --- ACCOUNT MANAGEMENT FUNCTIONS ---
        function showAccountsModal() {
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'super_admin')) {
                document.getElementById('accountsModal').style.display = 'flex';
                renderAccounts();
            } else {
                alert('Bạn không có quyền quản lý tài khoản.');
            }
        }
        function createAccount() {
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;
            const unit = document.getElementById('new-unit').value;

            if (!username || !password || !role || !unit) {
                alert('Vui lòng nhập đầy đủ thông tin.');
                return;
            }
            if (password.length < 3) {
                alert('Mật khẩu phải có ít nhất 3 ký tự.');
                return;
            }

            if (accounts[username]) {
                alert('Tên đăng nhập đã tồn tại.');
                return;
            }

            const newAccount = { password: password, role: role, unit: unit };
            
            database.ref('accounts/' + username).set(newAccount)
                .then(() => {
                    alert('Tài khoản đã được tạo thành công!');
                    document.getElementById('new-username').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('new-role').value = 'user_TP';
                    capNhatDonViTheoVaiTro();
                })
                .catch(error => {
                    alert('Lỗi khi tạo tài khoản: ' + error.message);
                });
        }
        function renderAccounts() {
            const list = document.getElementById('account-list');
            list.innerHTML = '';
            for (const username in accounts) {
                const account = accounts[username];
                if (username === currentUser.username) continue;
                const li = document.createElement('li');
                li.innerHTML = `
                    <div>
                        <strong>${username}</strong> (${account.role} - ${account.unit})
                    </div>
                    <div>
                        <button class="reset-btn" onclick="resetPasswordForAccount('${username}')">Reset Mật khẩu</button>
                        <button class="delete-btn" onclick="deleteAccount('${username}')">Xóa</button>
                    </div>
                `;
                list.appendChild(li);
            }
        }
        
        // Function to reset password for a sub-account
        function resetPasswordForAccount(username) {
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Bạn không có quyền thực hiện chức năng này.');
                return;
            }

            if (confirm(`Bạn có chắc chắn muốn đặt lại mật khẩu tài khoản ${username} về "123"?`)) {
                database.ref('accounts/' + username + '/password').set('123')
                    .then(() => {
                        alert(`Đã đặt lại mật khẩu cho tài khoản ${username} về "123" thành công!`);
                        // Cập nhật lại biến accounts cục bộ
                        if (accounts[username]) {
                            accounts[username].password = '123';
                        }
                    }).catch(error => {
                        alert('Lỗi khi đặt lại mật khẩu: ' + error.message);
                    });
            }
        }
        
        function deleteAccount(username) {
            if (confirm(`Bạn có chắc chắn muốn xóa tài khoản ${username}?`)) {
                database.ref('accounts/' + username).remove()
                    .then(() => {
                        alert('Tài khoản đã được xóa thành công.');
                    })
                    .catch(error => {
                        alert('Lỗi khi xóa tài khoản: ' + error.message);
                    });
            }
        }
        function capNhatDonViTheoVaiTro() {
            const roleSelect = document.getElementById('new-role');
            const unitSelect = document.getElementById('new-unit');
            const role = roleSelect.value;
            
            unitSelect.innerHTML = '';
            unitSelect.disabled = false;

            if (role.endsWith('_TP') || role === 'admin' || role === 'super_admin') {
                const option = document.createElement('option');
                option.value = 'Thành phố';
                option.textContent = 'Thành phố';
                unitSelect.appendChild(option);
            } else if (role.endsWith('_KV')) {
                lookupData['Đơn vị'].forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit;
                    option.textContent = unit;
                    unitSelect.appendChild(option);
                });
            }
        }
        
        // --- FORM & DATA FUNCTIONS ---
        function clearForm() {
            document.getElementById('ngay_nhan').value = new Date().toISOString().slice(0, 10);
            document.getElementById('nguon_don').value = '';
            document.getElementById('ho_ten').value = '';
            document.getElementById('dia_chi').value = '';
            document.getElementById('ngay_ghi').value = '';
            document.getElementById('phan_loai').value = 'Khiếu nại';
            document.getElementById('tham_quyen').value = 'Thuộc thẩm quyền giải quyết';
            document.getElementById('can_bo_phan_cong').value = currentUser ? currentUser.username : '';
            document.getElementById('chuc_danh').value = 'Kiểm sát viên trung cấp';
            document.getElementById('chuyen_den').value = '';
            document.getElementById('ngay_chuyen_don').value = '';
            document.getElementById('noi_dung').value = '';
            document.getElementById('de_xuat').value = '';
            document.getElementById('ket_qua').value = '';
            document.getElementById('edit-id').value = '';
            document.getElementById('can_cu_container').innerHTML = '';
            addCanCu();
        }

        function saveDon() {
            if (!currentUser) {
                alert('Vui lòng đăng nhập để lưu đơn.');
                return;
            }
            if (!document.getElementById('ho_ten').value || !document.getElementById('noi_dung').value) {
                alert('Vui lòng nhập Họ tên và Nội dung đơn.');
                return;
            }
            const id = document.getElementById('edit-id').value;
            const don = {
                ngay_nhan: document.getElementById('ngay_nhan').value,
                nguon_don: document.getElementById('nguon_don').value,
                ho_ten: document.getElementById('ho_ten').value,
                dia_chi: document.getElementById('dia_chi').value,
                ngay_ghi: document.getElementById('ngay_ghi').value,
                phan_loai: document.getElementById('phan_loai').value,
                tham_quyen: document.getElementById('tham_quyen').value,
                can_bo_phan_cong: document.getElementById('can_bo_phan_cong').value,
                chuc_danh: document.getElementById('chuc_danh').value,
                chuyen_den: document.getElementById('chuyen_den').value, 
                ngay_chuyen_don: document.getElementById('ngay_chuyen_don').value,
                can_cu: getCanCuData(),
                noi_dung: document.getElementById('noi_dung').value,
                de_xuat: document.getElementById('de_xuat').value,
                ket_qua: document.getElementById('ket_qua').value,
                lastUpdatedBy: currentUser.username,
                lastUpdated: new Date().toISOString()
            };

            const ref = id ? database.ref('dons/' + id) : database.ref('dons').push();
            ref.set(don)
                .then(() => {
                    alert(id ? 'Cập nhật đơn thành công!' : 'Lưu đơn thành công!');
                    clearForm();
                    updateTable();
                })
                .catch(error => {
                    alert('Lỗi khi lưu đơn: ' + error.message);
                });
        }
        
        function populateForm(don) {
            document.getElementById('ngay_nhan').value = don.ngay_nhan || '';
            document.getElementById('nguon_don').value = don.nguon_don || '';
            document.getElementById('ho_ten').value = don.ho_ten || '';
            document.getElementById('dia_chi').value = don.dia_chi || '';
            document.getElementById('ngay_ghi').value = don.ngay_ghi || '';
            document.getElementById('phan_loai').value = don.phan_loai || '';
            document.getElementById('tham_quyen').value = don.tham_quyen || '';
            document.getElementById('can_bo_phan_cong').value = don.can_bo_phan_cong || '';
            document.getElementById('chuc_danh').value = don.chuc_danh || '';
            document.getElementById('chuyen_den').value = don.chuyen_den || '';
            document.getElementById('ngay_chuyen_don').value = don.ngay_chuyen_don || '';
            populateCanCuFields(don.can_cu, '');
            document.getElementById('noi_dung').value = don.noi_dung || '';
            document.getElementById('de_xuat').value = don.de_xuat || '';
            document.getElementById('ket_qua').value = don.ket_qua || '';
            document.getElementById('edit-id').value = don.id;
        }

        function updateDon() {
            if (!currentUser) {
                alert('Vui lòng đăng nhập để cập nhật đơn.');
                return;
            }

            const id = document.getElementById('edit-id-modal').value;
            const updatedDon = {
                ngay_nhan: document.getElementById('sua-ngay_nhan').value,
                nguon_don: document.getElementById('sua-nguon_don').value,
                ho_ten: document.getElementById('sua-ho_ten').value,
                dia_chi: document.getElementById('sua-dia_chi').value,
                ngay_ghi: document.getElementById('sua-ngay_ghi').value,
                phan_loai: document.getElementById('sua-phan_loai').value,
                tham_quyen: document.getElementById('sua-tham_quyen').value,
                can_bo_phan_cong: document.getElementById('sua-can_bo_phan_cong').value,
                chuc_danh: document.getElementById('sua-chuc_danh').value,
                chuyen_den: document.getElementById('sua-chuyen_den').value, 
                ngay_chuyen_don: document.getElementById('sua-ngay_chuyen_don').value,
                can_cu: getCanCuData('sua-'),
                noi_dung: document.getElementById('sua-noi_dung').value,
                de_xuat: document.getElementById('sua-de_xuat').value,
                ket_qua: document.getElementById('sua-ket_qua').value,
                lastUpdatedBy: currentUser.username,
                lastUpdated: new Date().toISOString()
            };

            database.ref('dons/' + id).update(updatedDon)
                .then(() => {
                    alert('Cập nhật đơn thành công!');
                    document.getElementById('editModal').style.display = 'none';
                    updateTable();
                })
                .catch(error => {
                    alert('Lỗi khi cập nhật: ' + error.message);
                });
        }
        function deleteDon(id) {
            if (!currentUser) return alert('Vui lòng đăng nhập để xóa đơn.');
            
            if (confirm('Bạn có chắc chắn muốn xóa đơn này?')) {
                database.ref('dons/' + id).remove()
                    .then(() => {
                        alert('Đã xóa đơn thành công!');
                        updateTable();
                    })
                    .catch(error => {
                        alert('Lỗi khi xóa đơn: ' + error.message);
                    });
            }
        }
        function capNhatThamQuyenMacDinh(prefix = '') {
            const phanLoai = document.getElementById(prefix + 'phan_loai').value;
            const thamQuyenSelect = document.getElementById(prefix + 'tham_quyen');
            
            if (phanLoai === 'Yêu cầu bồi thường thiệt hại' || phanLoai === 'Đề nghị KN, GĐT, TT' || phanLoai === 'Đề nghị kiểm tra QĐGQKN') {
                thamQuyenSelect.value = 'Thuộc thẩm quyền giải quyết';
            } else if (phanLoai === 'Tin báo/Tố giác tội phạm trong HĐTP') {
                thamQuyenSelect.value = 'Thuộc thẩm quyền kiểm sát';
            } else {
                thamQuyenSelect.value = 'Không thuộc thẩm quyền';
            }
        }
        
        function initSelectOptions() {
            const selectIds = ['nguon_don', 'sua-nguon_don'];
            const chuyenDenIds = ['chuyen_den', 'sua-chuyen_den'];

            selectIds.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="">--Chọn--</option>';
                lookupData['Nguồn đơn'].forEach(nguon => {
                    select.appendChild(new Option(nguon, nguon));
                });
            });

            chuyenDenIds.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="">--Chọn--</option>';
                lookupData['Chuyển đến'].forEach(noi => { 
                    select.appendChild(new Option(noi, noi));
                });
            });
        }

        // --- CĂN CỨ FUNCTIONS ---
        function addCanCu(prefix = '') {
            const container = document.getElementById(prefix + 'can_cu_container');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'can-cu-item';

            const diemInput = document.createElement('input');
            diemInput.type = 'text';
            diemInput.placeholder = `Điểm`;

            const khoanInput = document.createElement('input');
            khoanInput.type = 'text';
            khoanInput.placeholder = `Khoản`;

            const dieuInput = document.createElement('input');
            dieuInput.type = 'text';
            dieuInput.placeholder = `Điều`;

            const vanBanInput = document.createElement('input');
            vanBanInput.type = 'text';
            vanBanInput.placeholder = `Văn bản`;

            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'Xóa';
            removeBtn.className = 'delete-btn';
            removeBtn.type = 'button'; 
            removeBtn.onclick = function() {
                container.removeChild(itemDiv);
            };

            itemDiv.appendChild(diemInput);
            itemDiv.appendChild(khoanInput);
            itemDiv.appendChild(dieuInput);
            itemDiv.appendChild(vanBanInput);
            itemDiv.appendChild(removeBtn);

            container.appendChild(itemDiv);
        }
        function getCanCuData(prefix = '') {
            const container = document.getElementById(prefix + 'can_cu_container');
            const items = container.querySelectorAll('.can-cu-item');
            const canCuArray = [];
            items.forEach(item => {
                const inputs = item.querySelectorAll('input');
                const canCuItem = {
                    diem: inputs[0].value.trim(),
                    khoan: inputs[1].value.trim(),
                    dieu: inputs[2].value.trim(),
                    vanBan: inputs[3].value.trim()
                };
                if (canCuItem.diem || canCuItem.khoan || canCuItem.dieu || canCuItem.vanBan) {
                    canCuArray.push(canCuItem);
                }
            });
            return canCuArray;
        }
        function populateCanCuFields(data, prefix = '') {
            const container = document.getElementById(prefix + 'can_cu_container');
            container.innerHTML = '';
            if (data && Array.isArray(data) && data.length > 0) {
                data.forEach(item => {
                    addCanCu(prefix);
                    const lastItem = container.lastElementChild;
                    const inputs = lastItem.querySelectorAll('input');
                    inputs[0].value = item.diem || '';
                    inputs[1].value = item.khoan || '';
                    inputs[2].value = item.dieu || '';
                    inputs[3].value = item.vanBan || '';
                });
            } else {
                addCanCu(prefix); 
            }
        }
        function getCanCuString(canCuArray) {
            if (!Array.isArray(canCuArray) || canCuArray.length === 0) return 'các quy định có liên quan';
            return canCuArray.map(item => {
                let parts = [];
                if (item.diem) parts.push(`Điểm ${item.diem}`);
                if (item.khoan) parts.push(`khoản ${item.khoan}`);
                if (item.dieu) parts.push(`Điều ${item.dieu}`);
                if (item.vanBan) parts.push(`Văn bản: ${item.vanBan}`);
                return parts.join(', ');
            }).join(';\n');
        }

        // --- EXPORT & REPORTING FUNCTIONS ---
        function formatDate(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        // Trả về định dạng DD/MM/YYYY
        return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
    } catch (e) {
        return dateString;
    }
}
 function createReportData(allData) {
    // allData là biến chứa dữ liệu đơn của bạn
    if (typeof allData === 'undefined' || Object.keys(allData).length === 0) {
        return [];
    }
    
    // 1. Nhóm và đếm số lượng đơn theo Tháng/Năm
    const monthlyCounts = {};

    Object.values(allData).forEach(don => {
        // Giả định 'ngayNhan' là cột 'Ngày nhận đơn' (ví dụ: "YYYY-MM-DD")
        const ngayNhan = don.ngayNhan; 
        if (ngayNhan) {
            const parts = ngayNhan.split('-');
            if (parts.length >= 2) {
                const monthYear = `${parts[1]}/${parts[0]}`; // Định dạng MM/YYYY
                monthlyCounts[monthYear] = (monthlyCounts[monthYear] || 0) + 1;
            }
        }
    });

    // 2. Sắp xếp các tháng và tính Tổng Cộng Dồn
    let cumulativeTotal = 0;
    const reportData = [];

    // Sắp xếp các tháng theo thứ tự thời gian
    const sortedMonths = Object.keys(monthlyCounts).sort((a, b) => {
        // Chuyển MM/YYYY sang YYYYMM để so sánh
        const [monthA, yearA] = a.split('/');
        const [monthB, yearB] = b.split('/');
        return parseInt(yearA + monthA) - parseInt(yearB + monthB);
    });

    sortedMonths.forEach(monthYear => {
        const countInMonth = monthlyCounts[monthYear];
        cumulativeTotal += countInMonth;

        reportData.push({
            'Tháng/Năm': monthYear,
            'Số Lượng Đơn Trong Tháng': countInMonth,
            'Tổng Cộng Dồn': cumulativeTotal
        });
    });

    return reportData;
}

// Thay thế hàm exportReportToExcel() hiện có của bạn bằng hàm này (sử dụng logic mới)
function exportReportToExcel() {
    if (typeof allData === 'undefined' || Object.keys(allData).length === 0) {
        alert("Không có dữ liệu đơn để tạo báo cáo!");
        return;
    }
    
    const reportData = createReportData(allData);
    const ws = XLSX.utils.json_to_sheet(reportData);

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "BaoCaoTongHop");
    XLSX.writeFile(wb, "BaoCaoTongHopSoLieuDon_Moi.xlsx");
}


function downloadResolutionResultDoc(id) {
    // Giả định 'allData' là biến chứa toàn bộ dữ liệu đơn của bạn
    if (typeof allData === 'undefined' || !allData[id]) {
        alert("Vui lòng chọn một đơn để trích xuất.");
        return;
    }
    const don = allData[id];
    
    const now = new Date();
    const day = now.getDate();
    const month = now.getMonth() + 1;
    const year = now.getFullYear();

    // Xử lý Căn cứ (Sử dụng XML cho việc ngắt dòng)
    const canCuText = (don.can_cu && don.can_cu.length > 0) 
        ? don.can_cu.map(c => 
            `<w:p><w:r><w:t>+ Điểm ${c.diem || '...'} Khoản ${c.khoan || '...'} Điều ${c.dieu || '...'} Văn bản: ${c.van_ban || '...'}</w:t></w:r></w:p>`
          ).join('')
        : '<w:p><w:r><w:t>Chưa cập nhật căn cứ.</w:t></w:r></w:p>';
        
    // Nội dung WordML với định dạng lề: Trên 2cm, Dưới 2cm, Trái 3cm, Phải 1.5cm
    // Twips: 1cm = 567 twips.
    // Lề trên 2cm = 1134 twips
    // Lề dưới 2cm = 1134 twips
    // Lề trái 3cm = 1701 twips
    // Lề phải 1.5cm = 850 twips
    const wordContent = `
        <w:document xmlns:w="http://schemas.microsoft.com/office/word/2003/wordml">
            <w:body>
                <w:sectPr>
                    <w:pgSz w:w="11906" w:h="16838" /> <w:pgMar w:top="1134" w:bottom="1134" w:left="1701" w:right="850" w:gutter="0" />
                </w:sectPr>

                <w:p w:align="center"><w:r><w:t>VIỆN KIỂM SÁT NHÂN DÂN</w:t></w:r></w:p>
                <w:p w:align="center"><w:r><w:t>THÀNH PHỐ CẦN THƠ, THANH TRA - KHIẾU TỐ</w:t></w:r></w:p>
                <w:p w:align="right"><w:r><w:t>CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</w:t></w:r></w:p>
                <w:p w:align="right"><w:r><w:t>Độc lập - Tự do - Hạnh phúc</w:t></w:r></w:p>

                <w:p><w:r><w:t/></w:r></w:p>
                <w:p w:align="center"><w:r><w:t>TRÍCH XUẤT KẾT QUẢ XỬ LÝ ĐƠN</w:t></w:r></w:p>
                <w:p><w:r><w:t/></w:r></w:p>
                
                <w:p><w:r><w:t>Đơn của:     ${don.hoTen || ''}</w:t></w:r></w:p>
                <w:p><w:r><w:t>Địa chỉ:      ${don.diaChi || ''}</w:t></w:r></w:p>
                <w:p><w:r><w:t>Đơn ghi ngày: ${don.donGhiNgay ? formatDate(don.donGhiNgay) : ''}</w:t></w:r></w:p>
                <w:p><w:r><w:t>Viện kiểm sát nhân dân thành phố Cần Thơ nhận đơn ngày: ${don.ngayNhan ? formatDate(don.ngayNhan) : ''}</w:t></w:r></w:p>
                <w:p><w:r><w:t>Nguồn đơn:    ${don.nguonDon || ''}</w:t></w:r></w:p>
                <w:p><w:r><w:t>Nội dung đơn: ${don.noiDung || ''}</w:t></w:r></w:p>

                <w:p><w:r><w:t>Căn cứ:</w:t></w:r></w:p>
                ${canCuText}

                <w:p><w:r><w:t>Đơn nêu trên đã được xử lý: ${don.ket_qua || 'Chưa có kết quả'}</w:t></w:r></w:p>
                <w:p><w:r><w:t>Ngày xử lý: ${don.ngayXuLy || ''}</w:t></w:r></w:p>

                <w:p><w:r><w:t/></w:r></w:p>
                <w:p w:align="right"><w:r><w:t>Cần Thơ, ngày ${day} tháng ${month} năm ${year}</w:t></w:r></w:p>
                <w:p w:align="right"><w:r><w:t>CÁN BỘ TRÍCH XUẤT</w:t></w:r></w:p>
                <w:p w:align="right"><w:r><w:t>(Ký, ghi rõ họ tên)</w:t></w:r></w:p>
                <w:p w:align="right"><w:r><w:t>${don.canBoPhanCong || '__________________'}</w:t></w:r></w:p>

            </w:body>
        </w:document>
    `;

    // Tạo và tải file .doc
    const filename = `KetQuaXuLyDon_${new Date().toLocaleDateString('vi-VN').replace(/\//g, '-')}.doc`;
    const blob = new Blob(['\ufeff', wordContent], {type: 'application/msword'});
    saveAs(blob, filename); 
}       
        function exportList() {
            if (dons.length === 0) {
                alert('Không có dữ liệu để xuất.');
                return;
            }
            const data = dons.map(don => ({
                'STT': don.stt,
                'Ngày nhận đơn': formatDate(don.ngay_nhan),
                'Nguồn đơn': don.nguon_don,
                'Họ tên/CQ/TC': don.ho_ten,
                'Địa chỉ': don.dia_chi,
                'Đơn ghi ngày': formatDate(don.ngay_ghi),
                'Phân loại': don.phan_loai,
                'Thẩm quyền': don.tham_quyen,
                'Cán bộ phân công': don.can_bo_phan_cong,
                'Chức danh': don.chuc_danh,
                'Chuyển đến': don.chuyen_den, 
                'Ngày chuyển đơn': formatDate(don.ngay_chuyen_don),
                'Căn cứ': getCanCuString(don.can_cu),
                'Nội dung đơn': don.noi_dung,
                'Đề xuất': don.de_xuat,
                'Kết quả': don.ket_qua,
                'Người cập nhật cuối': don.lastUpdatedBy,
                'Thời gian cập nhật cuối': don.lastUpdated
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Danh_sach_don");
            XLSX.writeFile(wb, "Danh_sach_don.xlsx");
        }

      
        function exportReport() {
            if (dons.length === 0) {
                alert('Không có dữ liệu để xuất báo cáo.');
                return;
            }
            
            // --- BƯỚC 1: TÍNH TOÁN SỐ LIỆU TỔNG HỢP ---
            let stats = {
                kn: 0, tc: 0, tbtg: 0, newOther: 0, // Phân loại (4, 5, 9, 6/7/8/10)
                tham_quyen_gq: 0, tham_quyen_ks: 0, khong_tham_quyen: 0, // Thẩm quyền (12, 21, 32)
                giai_quyet_gq: 0, giai_quyet_ks: 0, // Đã giải quyết (16, 27)
                chuyen_don: 0 // Chuyển đơn (từ Không thuộc thẩm quyền) (33)
            };

            dons.forEach(don => {
                // Phân loại đơn (Dòng 4, 5, 9, 3)
                if (don.phan_loai === 'Khiếu nại') stats.kn++; // Dòng 4
                else if (don.phan_loai === 'Tố cáo') stats.tc++; // Dòng 5
                else if (don.phan_loai === 'Tin báo/Tố giác tội phạm trong HĐTP') stats.tbtg++; // Dòng 9
                else stats.newOther++; // Dòng 6, 7, 8, 10 (Gom các loại đơn khác không định danh rõ)
                
                // Thẩm quyền (Dòng 12, 21, 32)
                if (don.tham_quyen === 'Thuộc thẩm quyền giải quyết') {
                    stats.tham_quyen_gq++; // Dòng 12
                    // Đã giải quyết (Dòng 16)
                    if (don.ket_qua && don.ket_qua.trim() !== '') {
                        stats.giai_quyet_gq++; 
                    }
                } else if (don.tham_quyen === 'Thuộc thẩm quyền kiểm sát') {
                    stats.tham_quyen_ks++; // Dòng 21
                    // Đã giải quyết (Dòng 27)
                    if (don.ket_qua && don.ket_qua.trim() !== '') {
                        stats.giai_quyet_ks++;
                    }
                } else if (don.tham_quyen === 'Không thuộc thẩm quyền') {
                    stats.khong_tham_quyen++; // Dòng 32
                    // Dòng 33: Chuyển đơn (có điền trường chuyển đến)
                    if (don.chuyen_den && don.chuyen_den.trim() !== '') {
                         stats.chuyen_don++; 
                    }
                }
            });
            
            // Tính toán các Dòng tổng hợp
            const totalNew = stats.kn + stats.tc + stats.tbtg + stats.newOther;             // Dòng 3 (Đơn mới)
            const totalAll = totalNew;                                                      // Dòng 1 (Tổng số = Đơn mới + Số cũ (0))
            const totalReceived = stats.tham_quyen_gq + stats.tham_quyen_ks + stats.khong_tham_quyen; // Dòng 11 (Tổng số đơn đã tiếp nhận)
            
            const tonGQ = stats.tham_quyen_gq - stats.giai_quyet_gq;                        // Dòng 20 (Còn tồn GQ)
            const tonKS = stats.tham_quyen_ks - stats.giai_quyet_ks;                        // Dòng 28 (Còn lại KS)
            
            // Dòng 37: Thông báo chỉ dẫn/ Trả lại đơn (Gộp 37, 38, 39: Số không thuộc thẩm quyền VÀ KHÔNG chuyển đơn)
            const thongBaoChiDanOrLuuDon = stats.khong_tham_quyen - stats.chuyen_don; 

            // --- BƯỚC 2: TẠO DỮ LIỆU BÁO CÁO (CHỈ TÍNH CỘT TỔNG) ---
            // Hàm tạo mảng 14 phần tử (13 số 0 cho các cột tháng + 1 số TỔNG)
            const createRow = (totalCount) => [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, totalCount];

            // Dùng cấu trúc mảng 45 dòng, mỗi dòng là một mảng dữ liệu.
            const reportData = [
                // Dòng 1-2
                { 'Dòng': 1, 'Chỉ tiêu': 'Tổng số', 'Data': createRow(totalAll) },
                { 'Dòng': 2, 'Chỉ tiêu': 'Số cũ chưa phân loại', 'Data': createRow(0) }, 
                // Dòng 3: Số đơn mới tiếp nhận
                { 'Dòng': 3, 'Chỉ tiêu': 'Số đơn mới tiếp nhận', 'Data': createRow(totalNew) },
                // Dòng 4-10: Tr.đó (Phân loại chi tiết)
                { 'Dòng': 4, 'Chỉ tiêu': '  Tr.đó: - Đơn khiếu nại', 'Data': createRow(stats.kn) },
                { 'Dòng': 5, 'Chỉ tiêu': '             - Đơn tố cáo', 'Data': createRow(stats.tc) },
                { 'Dòng': 6, 'Chỉ tiêu': '             - Đơn yêu cầu bồi thường thiệt hại do người tiến hành tố tụng gây ra', 'Data': createRow(0) }, 
                { 'Dòng': 7, 'Chỉ tiêu': '             - Đơn đề nghị kháng nghị giám đốc thẩm, tái thẩm', 'Data': createRow(0) }, 
                { 'Dòng': 8, 'Chỉ tiêu': '        - Đề nghị kiểm tra lại QĐGQKN', 'Data': createRow(0) }, 
                { 'Dòng': 9, 'Chỉ tiêu': '             - Đơn tin báo, tố giác TP trong hoạt động tư pháp', 'Data': createRow(stats.tbtg) },
                { 'Dòng': 10, 'Chỉ tiêu': '             - Đơn kiến nghị phản ánh và các loại đơn khác', 'Data': createRow(stats.newOther) },
                // Dòng 11: Tổng số đơn đã tiếp nhận
                { 'Dòng': 11, 'Chỉ tiêu': 'Tổng số đơn đã tiếp nhận', 'Data': createRow(totalReceived) },
                // Dòng 12-20: Thuộc thẩm quyền giải quyết (GQ)
                { 'Dòng': 12, 'Chỉ tiêu': 'Số đơn thuộc thẩm quyền giải quyết của VKS', 'Data': createRow(stats.tham_quyen_gq) },
                { 'Dòng': 13, 'Chỉ tiêu': 'Trong đó:, - Số cũ:', 'Data': createRow(0) }, 
                { 'Dòng': 14, 'Chỉ tiêu': ',- Số mới:', 'Data': createRow(stats.tham_quyen_gq) }, 
                { 'Dòng': 15, 'Chỉ tiêu': 'Tr.đó:  - Số đơn chuyển cơ quan Điều tra', 'Data': createRow(0) }, 
                { 'Dòng': 16, 'Chỉ tiêu': 'Đã giải quyết', 'Data': createRow(stats.giai_quyet_gq) },
                { 'Dòng': 17, 'Chỉ tiêu': 'Trong đó:, - Chấp nhận nội dung đơn', 'Data': createRow(0) }, 
                { 'Dòng': 18, 'Chỉ tiêu': ',- Đình chỉ', 'Data': createRow(0) }, 
                { 'Dòng': 19, 'Chỉ tiêu': ',- Bác đơn', 'Data': createRow(0) }, 
                { 'Dòng': 20, 'Chỉ tiêu': 'Còn tồn', 'Data': createRow(tonGQ) },
                // Dòng 21-28: Thuộc thẩm quyền kiểm sát (KS)
                { 'Dòng': 21, 'Chỉ tiêu': 'Số đơn thuộc thẩm quyền kiểm sát việc giải quyết khiếu nại, tố cáo và tin báo, tố giác tội phạm', 'Data': createRow(stats.tham_quyen_ks) },
                { 'Dòng': 22, 'Chỉ tiêu': ',Số cũ:', 'Data': createRow(0) }, 
                { 'Dòng': 23, 'Chỉ tiêu': ',Số mới:', 'Data': createRow(stats.tham_quyen_ks) }, 
                { 'Dòng': 24, 'Chỉ tiêu': ',Tr.đó:  - Số đơn chuyển cơ quan Điều tra', 'Data': createRow(0) }, 
                { 'Dòng': 25, 'Chỉ tiêu': '             - Số đơn chuyển Tòa án', 'Data': createRow(0) }, 
                { 'Dòng': 26, 'Chỉ tiêu': '             -  Số đơn chuyển cơ quan Thi hành án', 'Data': createRow(0) }, 
                { 'Dòng': 27, 'Chỉ tiêu': ',Đã giải quyết:', 'Data': createRow(stats.giai_quyet_ks) },
                { 'Dòng': 28, 'Chỉ tiêu': ',Còn lại:', 'Data': createRow(tonKS) },
                // Dòng 29-31: Chi tiết Còn lại (Giả sử 0)
                { 'Dòng': 29, 'Chỉ tiêu': ',Tr.đó:  - Số đơn chuyển cơ quan Điều tra', 'Data': createRow(0) },
                { 'Dòng': 30, 'Chỉ tiêu': '          - Số đơn chuyển Tòa án', 'Data': createRow(0) },
                { 'Dòng': 31, 'Chỉ tiêu': '             -  Số đơn chuyển cơ quan Thi hành án', 'Data': createRow(0) },
                // Dòng 32-39: Không thuộc thẩm quyền
                { 'Dòng': 32, 'Chỉ tiêu': 'Số đơn không thuộc thẩm quyền giải quyết của VKS và  không thuộc thẩm quyền kiểm sát việc giải quyết của VKS', 'Data': createRow(stats.khong_tham_quyen) },
                { 'Dòng': 33, 'Chỉ tiêu': '+ Chuyển đơn giải quyết theo thẩm quyền và báo tin cho người gửi đơn', 'Data': createRow(stats.chuyen_don) },
                // Dòng 34-36: Chi tiết Chuyển đơn (Giả sử 0)
                { 'Dòng': 34, 'Chỉ tiêu': ',Tr.đó:  - Số đơn chuyển cơ quan Điều tra', 'Data': createRow(0) },
                { 'Dòng': 35, 'Chỉ tiêu': '             - Số đơn chuyển Tòa án', 'Data': createRow(0) },
                { 'Dòng': 36, 'Chỉ tiêu': '             -  Số đơn chuyển cơ quan Thi hành án', 'Data': createRow(0) },
                { 'Dòng': 37, 'Chỉ tiêu': '+ Thông báo chỉ dẫn/ Trả lại đơn', 'Data': createRow(thongBaoChiDanOrLuuDon) }, 
                { 'Dòng': 38, 'Chỉ tiêu': '+ Lưu đơn', 'Data': createRow(0) }, 
                { 'Dòng': 39, 'Chỉ tiêu': '+ Không xem xét đơn tố cáo giấu tên, mạo tên, không rõ địa chỉ, không ký trực tiếp', 'Data': createRow(0) }, 
                // Dòng 40-45: Chi tiết khác (Giả sử 0)
                { 'Dòng': 40, 'Chỉ tiêu': 'Số lượt tiếp công dân', 'Data': createRow(0) },
                { 'Dòng': 41, 'Chỉ tiêu': ',Tr.đó:  Số lượt Lãnh đạo Viện kiểm sát tiếp công dân', 'Data': createRow(0) },
                { 'Dòng': 42, 'Chỉ tiêu': ',Nhận đơn', 'Data': createRow(0) },
                { 'Dòng': 43, 'Chỉ tiêu': 'Số cuộc KSTT, yêu cầu tự kiểm tra', 'Data': createRow(0) },
                { 'Dòng': 44, 'Chỉ tiêu': 'Kiến nghị', 'Data': createRow(0) },
                { 'Dòng': 45, 'Chỉ tiêu': 'Kháng nghị', 'Data': createRow(0) },
            ];
         
            const ws = XLSX.utils.aoa_to_sheet([]);
           
            XLSX.utils.sheet_add_aoa(ws, [
                ['SỐ LIỆU KHIẾU NẠI - TỐ CÁO', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''], // Dòng trống
                ['Dòng', 'Chỉ tiêu', 'NĂM 2025', '', '', 'NĂM 2026', '', '', '', '', '', '', '', '', 'TỔNG'], // Tiêu đề Năm
                ['', '', '10', '11', '12', '1', '2', '3', '4', '5', '6', '7', '8', '9', ''], // Tiêu đề Tháng
            ], { origin: -1 }); // Ghi vào đầu sheet
            
            if (!ws['!merges']) ws['!merges'] = [];
            ws['!merges'].push(
                { s: { r: 0, c: 0 }, e: { r: 0, c: 15 } }, // SỐ LIỆU KHIẾU NẠI - TỐ CÁO (A1:P1)
                { s: { r: 2, c: 2 }, e: { r: 2, c: 4 } }, // NĂM 2025 (C3:E3)
                { s: { r: 2, c: 5 }, e: { r: 2, c: 13 } } // NĂM 2026 (F3:N3)
            );
                      
            XLSX.utils.sheet_add_aoa(ws, reportData.map(r => [r['Dòng'], r['Chỉ tiêu'], ...r['Data']]), { origin: -1 });
           
            XLSX.utils.sheet_add_aoa(ws, [
                ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                ['CÔNG THỨC DIỄN GIẢI:'],
                ['Dòng 1= Dòng 2+3 (dòng 2 là số cũ chưa phân loại từ tháng trước chuyển sang)'],
                ['Dòng 3= Dòng 4+5+6+7+8+9+10'],
                ['Dòng 11= Dòng 12(= Dòng 13+14) + Dòng 21(=Dòng 22+23) + Dòng 32(= dòng 33+37+38+39)'],
                ['Số cũ tại Dòng 13 và Dòng 22 cột Tổng là số tồn từ kỳ báo cáo năm trước chuyển sang'],
            ], { origin: -1 });
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Bao_cao_thong_ke");
            XLSX.writeFile(wb, "Bao_cao_thong_ke.xlsx");
        }

        function downloadJSON() {
            if (dons.length === 0) {
                alert('Không có dữ liệu để sao lưu.');
                return;
            }
            const jsonString = JSON.stringify(dons, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            saveAs(blob, 'backup_dons.json');
        }

        function openProposalSlip(id) {
            const don = dons.find(d => d.id === id);
            if (!don) {
                alert('Không tìm thấy đơn để trích xuất.');
                return;
            }
            const canCuString = getCanCuString(don.can_cu);
            const today = new Date();
            const day = today.getDate().toString().padStart(2, '0');
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const year = today.getFullYear();
            const todayString = `Cần Thơ, ngày ${day} tháng ${month} năm ${year}`;
            
            // Sử dụng nhiều khoảng trắng để căn chỉnh trên môi trường <pre>
            const proposalContent = `
                                                                                  Mẫu số 07/KT 
                                                                       (Ban hành kèm theo QĐ số 28/QĐ-VKSTC 
                                                                                ngày 15/02/2023)
                                VIỆN KIỂM SÁT NHÂN DÂN                   CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM
                                   THÀNH PHỐ CẦN THƠ                          Độc lập - Tự do - Hạnh phúc
                                 THANH TRA - KHIẾU TỐ                         --------------------------- 
                                       ----------                                  ${todayString}
            
                                                            PHIẾU ĐỀ XUẤT XỬ LÝ ĐƠN
                                                            
                                           Kính gửi:  - Lãnh đạo Viện;
                                                      - Lãnh đạo Thanh tra - Khiếu tố.
                                                      
                         Tôi tên: ${don.can_bo_phan_cong || '....................'}, chức danh: ${don.chuc_danh || '....................'};
                         Được phân công nghiên cứu, đề xuất xử lý đối với đơn của ${don.ho_ten || '....................'}, địa chỉ: ${don.dia_chi || '....................'}, ghi ngày ${formatDate(don.ngay_ghi)} (Viện kiểm sát nhân dân thành phố Cần Thơ nhận đơn ngày ${formatDate(don.ngay_nhan)} do ${don.nguon_don} chuyển đến).
                         Nội dung đơn: ${don.noi_dung || ''}
                         Theo quy định tại ${canCuString} của Quy chế tiếp công dân, giải quyết khiếu nại, tố cáo và kiểm sát việc giải quyết khiếu nại, tố cáo trong hoạt động tư pháp (ban hành kèm theo Quyết định số: 222/QĐ-VKSTC ngày 22/6/2023), Đơn nêu trên ${don.tham_quyen}.
                         Tôi xin đề xuất: Lãnh đạo Viện phê duyệt ${don.de_xuat || '....................................................................'}
                           ${todayString}                   ${todayString}                           NGƯỜI ĐỀ XUẤT
                     Phê duyệt của Lãnh đạo Viện        Lãnh đạo đơn vị đề xuất                                                                           
                                                                                                  ${don.can_bo_phan_cong || '....................'}
            `;
            
            document.getElementById('proposal-content').textContent = proposalContent.trim();
            document.getElementById('proposalModal').style.display = 'flex';
        }
        
        function extractProposalSlip() {
             if (dons.length === 0) {
                alert('Vui lòng nhập hoặc chọn một đơn để trích xuất phiếu đề xuất.');
                return;
            }
            const currentEditId = document.getElementById('edit-id').value;
            if (currentEditId) {
                openProposalSlip(currentEditId);
            } else if (dons.length > 0) {
                 openProposalSlip(dons[0].id);
            }
        }
        
        function downloadProposalDoc() {
            const content = document.getElementById('proposal-content').textContent;
           
            const blob = new Blob([content], { type: 'application/msword' }); 
            saveAs(blob, 'Phieu_de_xuat.doc');
        }

      
        function updateTable() {
            const donBody = document.getElementById('don-body');
            donBody.innerHTML = '';

            database.ref('dons').once('value').then(snapshot => {
                dons = [];
                snapshot.forEach(childSnapshot => {
                    const don = childSnapshot.val();
                    if (don) {
                        don.id = childSnapshot.key;
                        dons.push(don);
                    }
                });

                dons.sort((a, b) => new Date(b.ngay_nhan) - new Date(a.ngay_nhan));

                let stt = 1;
                dons.forEach(don => {
                    const row = donBody.insertRow();
                    row.innerHTML = `
                        <td>${stt++}</td>
                        <td>${formatDate(don.ngay_nhan) || ''}</td>
                        <td>${don.ho_ten || ''}</td>
                        <td>${(don.noi_dung || '').substring(0, 50)}...</td>
                        <td>${don.phan_loai || ''}</td>
                        <td>${don.tham_quyen || ''}</td>
                        <td>${don.ket_qua ? 'Đã xử lý' : 'Chưa xử lý'}</td>
                        <td class="table-actions">
                            <button class="xu-ly-btn" onclick="handleDon('${don.id}')">Xử lý</button>
                            <button class="edit-btn" onclick="showEditModal('${don.id}')">Sửa</button>
                            <button class="export-proposal-btn" onclick="openProposalSlip('${don.id}')">Phiếu Đề xuất</button>
                            <button class="delete-btn" onclick="deleteDon('${don.id}')">Xóa</button>
                        </td>
                    `;
                });
            }).catch(error => {
                console.error("Lỗi khi tải dữ liệu từ Firebase:", error);
            });
        }
        function handleDon(id) {
            const don = dons.find(d => d.id === id);
            if (don) {
                populateForm(don);
            } else {
                alert('Không tìm thấy đơn.');
            }
        }
        
        function showEditModal(id) {
            const don = dons.find(d => d.id === id);
            if (!don) {
                alert('Không tìm thấy đơn để sửa.');
                return;
            }
            document.getElementById('editModal').style.display = 'flex';
            document.getElementById('sua-ngay_nhan').value = don.ngay_nhan || '';
            document.getElementById('sua-nguon_don').value = don.nguon_don || '';
            document.getElementById('sua-ho_ten').value = don.ho_ten || '';
            document.getElementById('sua-dia_chi').value = don.dia_chi || '';
            document.getElementById('sua-ngay_ghi').value = don.ngay_ghi || '';
            document.getElementById('sua-phan_loai').value = don.phan_loai || 'Khiếu nại';
            document.getElementById('sua-tham_quyen').value = don.tham_quyen || 'Thuộc thẩm quyền giải quyết';
            document.getElementById('sua-can_bo_phan_cong').value = don.can_bo_phan_cong || '';
            document.getElementById('sua-chuc_danh').value = don.chuc_danh || 'Kiểm sát viên trung cấp';
            document.getElementById('sua-chuyen_den').value = don.chuyen_den || ''; 
            document.getElementById('sua-ngay_chuyen_don').value = don.ngay_chuyen_don || '';
            populateCanCuFields(don.can_cu, 'sua-');
            document.getElementById('sua-noi_dung').value = don.noi_dung || '';
            document.getElementById('sua-de_xuat').value = don.de_xuat || '';
            document.getElementById('sua-ket_qua').value = don.ket_qua || '';
            
            let editIdModal = document.getElementById('edit-id-modal');
            if (!editIdModal) {
                editIdModal = document.createElement('input');
                editIdModal.type = 'hidden';
                editIdModal.id = 'edit-id-modal';
                document.querySelector('.modal-content.large-modal').appendChild(editIdModal);
            }
            editIdModal.value = id;
        }

        
        function init() {
            initializeDefaultAccounts(); 
            initSelectOptions();
            document.getElementById("ngay_nhan").value = new Date().toISOString().slice(0, 10);
            document.getElementById('new-role').onchange = capNhatDonViTheoVaiTro;
            capNhatDonViTheoVaiTro();
            populateCanCuFields([], '');
            populateCanCuFields([], 'sua-');
            
            document.getElementById('account-btn').style.display = 'none';
        }

        window.onload = init;
    </script>
</body>
</html>
