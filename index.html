<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    
    <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self'; 
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; 
                 script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://*.googleapis.com https://*.firebaseio.com https://*.firebasedatabase.app https://*.jsdelivr.net; 
                 connect-src 'self' https://www.gstatic.com https://*.googleapis.com https://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebaseio.com wss://*.firebasedatabase.app https://*.jsdelivr.net;
                 img-src 'self' data: https://vienkiemsat.cantho.gov.vn https://upload.wikimedia.org blob:;">

    <title>Phần Mềm Quản Lý Đơn Khiếu nại - Tố Cáo</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }
        
        .header {
            background-color: #004a99;
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .container {
            width: 98%;
            margin: 20px auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        /* LOGIN FORM */
        #login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        #login-container h2 {
            margin-bottom: 20px;
            color: #004a99;
        }
        #login-container input {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        #login-container button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            margin-top: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        #login-container button:hover {
            background-color: #0056b3;
        }
        
        /* MAIN INTERFACE */
        #main-container {
            display: none;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-area {
            display: flex;
            gap: 20px;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
        }
        
        .form-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .form-actions button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .form-actions .save-btn { background-color: #28a745; color: white; }
        .form-actions .save-btn:hover { background-color: #1e7e34; }
        .form-actions .clear-btn { background-color: #ffc107; color: #333; }
        .form-actions .clear-btn:hover { background-color: #e0a800; }
        .form-actions .excel-btn { background-color: #004a99; color: white; }
        .form-actions .excel-btn:hover { background-color: #003366; }
        
        /* DATA TABLE */
        .data-area {
            overflow-x: auto;
        }
        
        .data-area h3 {
            border-bottom: 2px solid #ccc;
            padding-bottom: 5px;
            margin-top: 0;
            color: #004a99;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background-color: white;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 14px;
            white-space: nowrap;
        }
        
        th {
            background-color: #004a99;
            color: white;
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) { background-color: #f2f2f2; }
        
        .table-actions button {
            padding: 5px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .table-actions .edit-btn { background-color: #17a2b8; color: white; }
        .table-actions .delete-btn { background-color: #dc3545; color: white; }
        
        /* CAN CU STYLES */
        .can-cu-field {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }
        
        .can-cu-field input {
            flex: 1;
        }
        
        .can-cu-field button {
            padding: 5px 10px;
        }
        
        .can-cu-container {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }

        /* SEARCH BAR STYLES */
        .search-bar {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .search-bar input[type="text"] {
            flex: 1; /* Cho ô text chiếm phần lớn không gian */
        }
        .search-bar button {
            padding: 8px 15px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            font-weight: bold;
        }
        .search-bar .search-btn { background-color: #007bff; color: white; }
        .search-bar .reset-btn { background-color: #6c757d; color: white; }
        .search-bar button:hover { opacity: 0.9; }
        
    </style>
</head>
<body>

    <div class="header">
        <h1>Phần Mềm Quản Lý Đơn Khiếu nại - Tố Cáo</h1>
    </div>

    <div class="container">
        
        <div id="login-container">
            <h2>Đăng Nhập Hệ Thống</h2>
            <input type="text" id="username" placeholder="Tên đăng nhập" required>
            <input type="password" id="password" placeholder="Mật khẩu" required>
            <button onclick="login()">Đăng Nhập</button>
            <div id="register-message" style="margin-top: 15px; font-size: 14px;"></div>
        </div>
        
        <div id="main-container">

            <div style="text-align: right; margin-bottom: 10px;">
                <span id="welcome-message" style="margin-right: 15px; font-weight: bold;"></span>
                <button id="account-btn" onclick="toggleAccountManagement()" style="padding: 8px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;">Quản lý Tài khoản</button>
                <button onclick="logout()" style="padding: 8px 15px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Đăng Xuất</button>
            </div>

            <div class="search-bar" style="margin-bottom: 20px;">
                <input type="text" id="search-text" placeholder="Tìm kiếm theo Họ tên/Cơ quan/Tổ chức..." style="padding: 8px; width: 40%; border: 1px solid #ccc; border-radius: 4px;">
                <input type="date" id="search-date" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                <button class="search-btn" onclick="filterTable()">Tìm Kiếm</button>
                <button class="reset-btn" onclick="resetFilter()">Xóa Bộ Lọc</button>
            </div>
            
            <div class="form-area">
                <div class="form-column">
                    <input type="hidden" id="edit-id">
                    
                    <div class="form-group">
                        <label for="ngay_nhan">Ngày nhận đơn</label>
                        <input type="date" id="ngay_nhan">
                    </div>
                    
                    <div class="form-group">
                        <label for="nguon_don">Nguồn đơn</label>
                        <select id="nguon_don">
                            </select>
                    </div>

                    <div class="form-group">
                        <label for="ho_ten">Họ tên/Cơ quan/Tổ chức</label>
                        <input type="text" id="ho_ten">
                    </div>
                    
                    <div class="form-group">
                        <label for="dia_chi">Địa chỉ</label>
                        <input type="text" id="dia_chi">
                    </div>
                    
                    <div class="form-group">
                        <label for="ngay_ghi">Ngày ghi đơn</label>
                        <input type="date" id="ngay_ghi">
                    </div>

                    <div class="form-group">
                        <label for="phan_loai">Phân loại</label>
                        <select id="phan_loai" onchange="autoSelectThamQuyen()">
                            </select>
                    </div>

                    <div class="form-group">
                        <label for="tham_quyen">Thẩm quyền giải quyết</label>
                        <select id="tham_quyen">
                            </select>
                    </div>
                </div>
                
                <div class="form-column">
                    <div class="form-group">
                        <label for="can_bo_phan_cong">Cán bộ được phân công</label>
                        <input type="text" id="can_bo_phan_cong" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="chuc_danh">Chức danh</label>
                        <input type="text" id="chuc_danh">
                    </div>
                    
                    <div class="form-group">
                        <label for="chuyen_den">Chuyển đến</label>
                        <input type="text" id="chuyen_den">
                    </div>
                    
                    <div class="form-group">
                        <label for="ngay_chuyen_don">Ngày chuyển đơn</label>
                        <input type="date" id="ngay_chuyen_don">
                    </div>

                    <div class="form-group">
                        <label for="can_cu_container">Căn cứ (Quyết định, Thông báo, etc.)</label>
                        <div id="can-cu-container" class="can-cu-container">
                            </div>
                        <button onclick="addCanCuField('sua-')" style="margin-top: 5px; padding: 5px; background-color: #3f609e; color: white; border: none; border-radius: 4px;">Thêm Căn Cứ</button>
                    </div>
                </div>

                <div class="form-column">
                    <div class="form-group">
                        <label for="noi_dung">Nội dung đơn</label>
                        <textarea id="noi_dung" rows="4"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="de_xuat">Đề xuất</label>
                        <textarea id="de_xuat" rows="4"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="ket_qua">Kết quả giải quyết</label>
                        <textarea id="ket_qua" rows="4"></textarea>
                    </div>

                    <div class="form-actions">
                        <button class="save-btn" onclick="saveDon()">Lưu Đơn</button>
                        <button class="clear-btn" onclick="clearForm()">Nhập Mới</button>
                        <button class="excel-btn" onclick="exportToExcel()">Xuất Excel</button>
                    </div>
                </div>
            </div>

            <div id="account-management" style="display: none; margin-top: 20px;">
                <h3>Quản lý Tài khoản</h3>
                <div style="display: flex; gap: 20px; background-color: #f9f9f9; padding: 15px; border-radius: 6px;">
                    <div style="flex: 1; border-right: 1px solid #ddd; padding-right: 20px;">
                        <h4>Thêm Tài khoản Mới</h4>
                        <div class="form-group"><input type="text" id="new-username" placeholder="Tên đăng nhập mới" required></div>
                        <div class="form-group"><input type="password" id="new-password" placeholder="Mật khẩu" required></div>
                        <div class="form-group">
                            <select id="new-role" onchange="capNhatDonViTheoVaiTro()">
                                <option value="user">Cán bộ (Mặc định)</option>
                                <option value="admin">Quản lý Đơn</option>
                                <option value="super_admin">Super Admin</option>
                            </select>
                        </div>
                        <div class="form-group"><input type="text" id="new-unit" placeholder="Đơn vị công tác" required></div>
                        <button onclick="createAccount()" style="padding: 10px 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">Tạo Tài khoản</button>
                    </div>
                    
                    <div style="flex: 1;">
                        <h4>Danh sách Tài khoản</h4>
                        <table id="account-table">
                            <thead>
                                <tr>
                                    <th>Tên đăng nhập</th>
                                    <th>Vai trò</th>
                                    <th>Đơn vị</th>
                                    <th>Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="account-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="data-area" style="margin-top: 20px;">
                <h3>Danh sách Đơn đã tiếp nhận</h3>
                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Ngày nhận</th>
                            <th>Họ tên/Cơ quan/Tổ chức</th>
                            <th>Nội dung tóm tắt</th>
                            <th>Phân loại</th>
                            <th>Thẩm quyền</th>
                            <th>Kết quả</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="don-body">
                        </tbody>
                </table>
            </div>

        </div>

    </div>

    <script>
        // --- FIREBASE CONFIGURATION ---
        // Vui lòng thay thế cấu hình dưới đây bằng cấu hình Firebase của bạn
        const firebaseConfig = {
            // apiKey: "YOUR_API_KEY", 
            // authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "YOUR_DATABASE_URL", // BẮT BUỘC PHẢI CÓ
            // projectId: "YOUR_PROJECT_ID",
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // --- GLOBAL VARIABLES ---
        let currentUser = null;
        let dons = []; // Lưu trữ dữ liệu gốc đã tải từ Firebase
        
        // --- HELPER FUNCTIONS ---

        // Hàm chuyển đổi từ YYYY-MM-DD (hoặc ISO string) sang DD/MM/YYYY để hiển thị
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            const datePart = dateString.substring(0, 10); // Lấy phần YYYY-MM-DD
            const parts = datePart.split('-');
            if (parts.length === 3) {
                return `${parts[2]}/${parts[1]}/${parts[0]}`; // DD/MM/YYYY
            }
            return dateString;
        }

        function formatDateToInput(dateString) {
            if (!dateString) return '';
            // Input type="date" requires YYYY-MM-DD format
            return dateString.substring(0, 10);
        }

        // --- AUTHENTICATION FUNCTIONS ---

        // Hàm kiểm tra và khởi tạo tài khoản mặc định
        function initializeDefaultAccounts() {
            database.ref('accounts/super_admin').once('value', snapshot => {
                if (!snapshot.exists()) {
                    database.ref('accounts/super_admin').set({
                        password: 'admin', // Mật khẩu mặc định
                        role: 'super_admin',
                        unit: 'VKSND TP Cần Thơ'
                    }).then(() => {
                        const msg = document.getElementById('register-message');
                        msg.textContent = 'Tài khoản Super Admin mặc định (super_admin/admin) đã được tạo.';
                        msg.style.color = 'green';
                    }).catch(error => {
                        console.error("Lỗi khi tạo tài khoản mặc định:", error);
                    });
                }
            });
        }
        
        // Hàm đăng nhập
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Dùng username để truy vấn CƠ SỞ DỮ LIỆU
            database.ref('accounts/' + username).once('value')
                .then(snapshot => {
                    const accountData = snapshot.val();
                    
                    if (accountData && accountData.password === password) {
                        currentUser = { 
                            username: username, 
                            role: accountData.role, 
                            unit: accountData.unit 
                        };
                        
                        document.getElementById('welcome-message').textContent = `Xin chào, ${currentUser.username} (${currentUser.unit})`;
                        document.getElementById('login-container').style.display = 'none';
                        document.getElementById('main-container').style.display = 'flex';
                        document.getElementById('can_bo_phan_cong').value = currentUser.username;
                        
                        // Phân quyền hiển thị nút Quản lý
                        if (currentUser.role === 'admin' || currentUser.role === 'super_admin') {
                            document.getElementById('account-btn').style.display = 'block';
                        } else {
                            document.getElementById('account-btn').style.display = 'none';
                        }
                        
                        // Lập tức tải dữ liệu ĐƠN
                        updateTable(); 
                    } else {
                        alert('Tên đăng nhập hoặc mật khẩu không đúng!');
                    }
                })
                .catch(error => {
                    alert('Lỗi khi đăng nhập. Vui lòng kiểm tra kết nối hoặc Rules Firebase. Lỗi: ' + error.message);
                });
        }

        // Hàm đăng xuất
        function logout() {
            currentUser = null;
            document.getElementById('login-container').style.display = 'block';
            document.getElementById('main-container').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            // Ẩn quản lý tài khoản nếu đang mở
            document.getElementById('account-management').style.display = 'none';
        }

        // --- DATA MANAGEMENT FUNCTIONS ---

        // Hàm lưu đơn
        function saveDon() {
            if (!currentUser) {
                alert('Vui lòng đăng nhập để lưu đơn.');
                return;
            }
            if (!document.getElementById('ho_ten').value || !document.getElementById('noi_dung').value) {
                alert('Vui lòng nhập Họ tên và Nội dung đơn.');
                return;
            }
            
            const id = document.getElementById('edit-id').value;
            const isNew = !id; 

            const don = {
                ngay_nhan: document.getElementById('ngay_nhan').value,
                nguon_don: document.getElementById('nguon_don').value,
                ho_ten: document.getElementById('ho_ten').value,
                dia_chi: document.getElementById('dia_chi').value,
                ngay_ghi: document.getElementById('ngay_ghi').value,
                phan_loai: document.getElementById('phan_loai').value,
                tham_quyen: document.getElementById('tham_quyen').value,
                can_bo_phan_cong: document.getElementById('can_bo_phan_cong').value,
                chuc_danh: document.getElementById('chuc_danh').value,
                chuyen_den: document.getElementById('chuyen_den').value,
                ngay_chuyen_don: document.getElementById('ngay_chuyen_don').value,
                can_cu: getCanCuData(),
                noi_dung: document.getElementById('noi_dung').value,
                de_xuat: document.getElementById('de_xuat').value,
                ket_qua: document.getElementById('ket_qua').value,
                lastUpdatedBy: currentUser.username,
                lastUpdated: new Date().toISOString(),
                // Bổ sung nguoi_tao_uid cho đơn mới
                ...(isNew ? { nguoi_tao_uid: currentUser.username } : {}) 
            };
            
            const ref = id ? database.ref('don_khieu_to/' + id) : database.ref('don_khieu_to').push();
            
            ref.set(don)
                .then(() => {
                    alert(id ? 'Cập nhật đơn thành công!' : 'Lưu đơn thành công!');
                    clearForm();
                })
                .catch(error => {
                    alert('Lỗi khi lưu đơn. Vui lòng kiểm tra Rules Firebase. Lỗi: ' + error.message);
                });
        }

        // Hàm tải dữ liệu và áp dụng bộ lọc (đã sửa để phân quyền)
        function updateTable() {
            if (!currentUser) {
                return; 
            }
            
            let ref = database.ref('don_khieu_to');

            // --- QUAN TRỌNG: Lọc dữ liệu theo vai trò ---
            // Nếu người dùng KHÔNG phải là admin/super_admin, chỉ truy vấn đơn của họ
            if (currentUser.role !== 'admin' && currentUser.role !== 'super_admin') {
                ref = ref.orderByChild('nguoi_tao_uid').equalTo(currentUser.username);
            } 
            // ---------------------------------------------
            
            ref.on('value', (snapshot) => {
                const duLieu = snapshot.val();
                dons = [];
                
                if (duLieu) {
                    for (const id in duLieu) {
                        // Thêm vào mảng chỉ những đơn mà người dùng có quyền đọc (đã được Rules cho phép)
                        dons.push({ id: id, ...duLieu[id] });
                    }
                }

                // Sắp xếp theo ngày nhận đơn mới nhất
                dons.sort((a, b) => new Date(b.ngay_nhan) - new Date(a.ngay_nhan));
                
                // Hiển thị toàn bộ dữ liệu (chưa lọc tìm kiếm)
                displayDons(dons);
                
            }, (error) => {
                console.error("Lỗi khi tải dữ liệu: ", error);
                // alert('Lỗi tải dữ liệu. Vui lòng kiểm tra lại Rules Firebase.');
            });
        }

        // Hàm hiển thị dữ liệu lên bảng (Được dùng bởi updateTable và filterTable)
        function displayDons(data) {
            const tableBody = document.getElementById('don-body');
            tableBody.innerHTML = ''; 
            
            data.forEach((don, index) => {
                const row = tableBody.insertRow();
                const ngayNhanFormatted = formatDateForDisplay(don.ngay_nhan); // DD/MM/YYYY
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${ngayNhanFormatted}</td>
                    <td>${don.ho_ten}</td>
                    <td onclick="editDon('${don.id}')" style="cursor:pointer; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${don.noi_dung}">${don.noi_dung}</td>
                    <td>${don.phan_loai || ''}</td>
                    <td>${don.tham_quyen || ''}</td>
                    <td style="white-space: pre-wrap;">${don.ket_qua || ''}</td>
                    <td class="table-actions">
                        <button class="edit-btn" onclick="editDon('${don.id}')">Sửa</button>
                        <button class="delete-btn" onclick="deleteDon('${don.id}')">Xóa</button>
                    </td>
                `;
            });
        }

        // --- SEARCH FUNCTIONS ---

        function filterTable() {
            const searchText = document.getElementById('search-text').value.toLowerCase().trim();
            const searchDate = document.getElementById('search-date').value; // YYYY-MM-DD
            
            // Lọc trên mảng 'dons' gốc
            filteredDons = dons.filter(don => {
                let textMatch = true;
                let dateMatch = true;

                // 1. Lọc theo Họ tên/Cơ quan/Tổ chức
                if (searchText) {
                    textMatch = don.ho_ten && don.ho_ten.toLowerCase().includes(searchText);
                }

                // 2. Lọc theo Ngày nhận đơn
                if (searchDate) {
                    const donNgayNhanYMD = don.ngay_nhan ? don.ngay_nhan.substring(0, 10) : ''; 
                    dateMatch = donNgayNhanYMD === searchDate;
                }

                return textMatch && dateMatch;
            });

            // Hiển thị dữ liệu đã được lọc
            displayDons(filteredDons); 
        }

        function resetFilter() {
            document.getElementById('search-text').value = '';
            document.getElementById('search-date').value = '';
            // Hiển thị lại toàn bộ dữ liệu gốc
            displayDons(dons); 
        }

        // Hàm sửa đơn
        function editDon(id) {
            const don = dons.find(d => d.id === id);
            if (!don) return;

            // Kiểm tra quyền sửa (Rules sẽ chặn, nhưng nên kiểm tra ở client để tiện)
            if (currentUser.role !== 'admin' && currentUser.role !== 'super_admin' && don.nguoi_tao_uid !== currentUser.username) {
                alert('Bạn không có quyền sửa đơn này.');
                return;
            }

            document.getElementById('edit-id').value = id;
            document.getElementById('ngay_nhan').value = formatDateToInput(don.ngay_nhan);
            document.getElementById('nguon_don').value = don.nguon_don || '';
            document.getElementById('ho_ten').value = don.ho_ten || '';
            document.getElementById('dia_chi').value = don.dia_chi || '';
            document.getElementById('ngay_ghi').value = formatDateToInput(don.ngay_ghi);
            document.getElementById('phan_loai').value = don.phan_loai || '';
            document.getElementById('tham_quyen').value = don.tham_quyen || '';
            document.getElementById('can_bo_phan_cong').value = don.can_bo_phan_cong || '';
            document.getElementById('chuc_danh').value = don.chuc_danh || '';
            document.getElementById('chuyen_den').value = don.chuyen_den || '';
            document.getElementById('ngay_chuyen_don').value = formatDateToInput(don.ngay_chuyen_don);
            
            populateCanCuFields(don.can_cu || [], 'sua-'); // Tải căn cứ
            
            document.getElementById('noi_dung').value = don.noi_dung || '';
            document.getElementById('de_xuat').value = don.de_xuat || '';
            document.getElementById('ket_qua').value = don.ket_qua || '';

            // Cuộn lên đầu form để sửa
            window.scrollTo(0, 0);
        }

        // Hàm xóa đơn
        function deleteDon(id) {
            const don = dons.find(d => d.id === id);
            if (!don) return;

            // Kiểm tra quyền xóa
            if (currentUser.role !== 'admin' && currentUser.role !== 'super_admin' && don.nguoi_tao_uid !== currentUser.username) {
                alert('Bạn không có quyền xóa đơn này.');
                return;
            }

            if (confirm('Bạn có chắc chắn muốn xóa đơn này không?')) {
                database.ref('don_khieu_to/' + id).remove()
                    .then(() => {
                        alert('Xóa đơn thành công!');
                    })
                    .catch(error => {
                        alert('Lỗi khi xóa đơn. Vui lòng kiểm tra Rules Firebase. Lỗi: ' + error.message);
                    });
            }
        }

        // Hàm nhập mới/xóa form
        function clearForm() {
            document.getElementById('edit-id').value = '';
            document.getElementById('ngay_nhan').value = new Date().toISOString().slice(0, 10);
            document.getElementById('nguon_don').value = 'Đơn trực tiếp';
            document.getElementById('ho_ten').value = '';
            document.getElementById('dia_chi').value = '';
            document.getElementById('ngay_ghi').value = '';
            document.getElementById('phan_loai').value = 'Không';
            document.getElementById('tham_quyen').value = 'Không thuộc thẩm quyền';
            document.getElementById('chuc_danh').value = '';
            document.getElementById('chuyen_den').value = '';
            document.getElementById('ngay_chuyen_don').value = '';
            document.getElementById('noi_dung').value = '';
            document.getElementById('de_xuat').value = '';
            document.getElementById('ket_qua').value = '';
            
            // Đặt lại Cán bộ phân công theo người dùng hiện tại
            if (currentUser) {
                document.getElementById('can_bo_phan_cong').value = currentUser.username;
            }

            // Xóa các trường căn cứ
            populateCanCuFields([], 'sua-'); 
        }

        // --- CĂN CỨ FUNCTIONS ---
        function getCanCuData() {
            const container = document.getElementById('can-cu-container');
            const inputs = container.querySelectorAll('input[type="text"]');
            const canCuArray = [];
            inputs.forEach(input => {
                if (input.value.trim()) {
                    canCuArray.push(input.value.trim());
                }
            });
            return canCuArray;
        }

        function populateCanCuFields(canCuArray, prefix) {
            const container = document.getElementById('can-cu-container');
            container.innerHTML = '';
            
            if (canCuArray.length === 0) {
                addCanCuField(prefix);
                return;
            }

            canCuArray.forEach(value => {
                addCanCuField(prefix, value);
            });
        }

        function addCanCuField(prefix, value = '') {
            const container = document.getElementById('can-cu-container');
            const fieldId = 'can-cu-' + Date.now();
            
            const div = document.createElement('div');
            div.className = 'can-cu-field';
            div.id = fieldId;
            
            div.innerHTML = `
                <input type="text" value="${value}" placeholder="Số/Tên Quyết định, Thông báo...">
                <button onclick="removeCanCuField('${fieldId}')" type="button" style="background-color: #dc3545; color: white;">Xóa</button>
            `;
            container.appendChild(div);
        }

        function removeCanCuField(fieldId) {
            const container = document.getElementById('can-cu-container');
            const field = document.getElementById(fieldId);
            if (field) {
                container.removeChild(field);
            }
        }

        // --- ACCOUNT MANAGEMENT FUNCTIONS ---
        
        // Ẩn/hiện khu vực quản lý tài khoản
        function toggleAccountManagement() {
            const accountManagement = document.getElementById('account-management');
            if (accountManagement.style.display === 'none') {
                if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'super_admin')) {
                    accountManagement.style.display = 'block';
                    loadAccounts();
                }
            } else {
                accountManagement.style.display = 'none';
            }
        }
        
        // Tải danh sách tài khoản
        function loadAccounts() {
            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'super_admin')) {
                return;
            }

            database.ref('accounts').once('value', snapshot => {
                const accounts = snapshot.val();
                const accountBody = document.getElementById('account-body');
                accountBody.innerHTML = '';

                for (const username in accounts) {
                    const account = accounts[username];
                    const row = accountBody.insertRow();
                    row.innerHTML = `
                        <td>${username}</td>
                        <td>${account.role}</td>
                        <td>${account.unit || ''}</td>
                        <td>
                            ${username !== 'super_admin' ? `<button onclick="deleteAccount('${username}')" class="delete-btn">Xóa</button>` : 'System'}
                        </td>
                    `;
                }
            });
        }
        
        // Tạo tài khoản mới
        function createAccount() {
            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'super_admin')) {
                alert('Bạn không có quyền tạo tài khoản.');
                return;
            }
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;
            const unit = document.getElementById('new-unit').value;
            
            if (!username || !password) {
                alert('Vui lòng nhập Tên đăng nhập và Mật khẩu.');
                return;
            }

            database.ref('accounts/' + username).once('value', snapshot => {
                if (snapshot.exists()) {
                    alert('Tên đăng nhập đã tồn tại.');
                } else {
                    database.ref('accounts/' + username).set({
                        password: password,
                        role: role,
                        unit: unit
                    }).then(() => {
                        alert('Tạo tài khoản thành công!');
                        document.getElementById('new-username').value = '';
                        document.getElementById('new-password').value = '';
                        document.getElementById('new-unit').value = '';
                        loadAccounts(); // Tải lại danh sách
                    }).catch(error => {
                        alert('Lỗi khi tạo tài khoản: ' + error.message);
                    });
                }
            });
        }
        
        // Xóa tài khoản
        function deleteAccount(username) {
            if (!currentUser || currentUser.role !== 'super_admin') {
                alert('Bạn chỉ có quyền xóa tài khoản nếu là Super Admin.');
                return;
            }
            if (username === currentUser.username) {
                alert('Bạn không thể tự xóa tài khoản của mình.');
                return;
            }
            if (confirm(`Bạn có chắc chắn muốn xóa tài khoản "${username}" không?`)) {
                database.ref('accounts/' + username).remove()
                    .then(() => {
                        alert(`Tài khoản ${username} đã bị xóa.`);
                        loadAccounts();
                    })
                    .catch(error => {
                        alert('Lỗi khi xóa tài khoản: ' + error.message);
                    });
            }
        }
        
        // Cập nhật đơn vị công tác theo vai trò
        function capNhatDonViTheoVaiTro() {
            const role = document.getElementById('new-role').value;
            const unitInput = document.getElementById('new-unit');
            if (role === 'super_admin') {
                unitInput.value = 'VKSND TP Cần Thơ';
            } else if (role === 'admin') {
                unitInput.value = 'Phòng';
            } else {
                unitInput.value = 'Đơn vị';
            }
        }

        // --- UTILITY FUNCTIONS ---
        
        // Tự động chọn thẩm quyền dựa trên phân loại
        function autoSelectThamQuyen() {
            const phanLoaiSelect = document.getElementById('phan_loai');
            const thamQuyenSelect = document.getElementById('tham_quyen');
            const phanLoai = phanLoaiSelect.value;
            
            if (phanLoai === 'Giám đốc thẩm' || phanLoai === 'Tái thẩm' || phanLoai === 'Tranh chấp') {
                thamQuyenSelect.value = 'Thuộc thẩm quyền kiểm sát';
            } else if (phanLoai === 'Khiếu nại' || phanLoai === 'Tố cáo') {
                thamQuyenSelect.value = 'Thuộc thẩm quyền giải quyết';
            } else if (phanLoai === 'Kiến nghị/Phản ánh/Khác' || phanLoai === 'Yêu cầu bồi thường thiệt hại' || phanLoai === 'Không') {
                thamQuyenSelect.value = 'Không thuộc thẩm quyền';
            }
        }

        // Khởi tạo các options cho Select
        function initSelectOptions() {
            // NGUỒN ĐƠN
            const nguonDonOptions = ['Đơn trực tiếp', 'Qua bưu điện', 'Cổng thông tin', 'Khác'];
            const nguonDonSelect = document.getElementById('nguon_don');
            nguonDonOptions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                nguonDonSelect.appendChild(option);
            });

            // PHÂN LOẠI
            const phanLoaiOptions = ['Không', 'Khiếu nại', 'Tố cáo', 'Giám đốc thẩm', 'Tái thẩm', 'Tranh chấp', 'Kiến nghị/Phản ánh/Khác', 'Yêu cầu bồi thường thiệt hại'];
            const phanLoaiSelect = document.getElementById('phan_loai');
            phanLoaiOptions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                phanLoaiSelect.appendChild(option);
            });
            phanLoaiSelect.value = 'Không';

            // THẨM QUYỀN
            const thamQuyenOptions = ['Không thuộc thẩm quyền', 'Thuộc thẩm quyền kiểm sát', 'Thuộc thẩm quyền giải quyết'];
            const thamQuyenSelect = document.getElementById('tham_quyen');
            thamQuyenOptions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                thamQuyenSelect.appendChild(option);
            });
            thamQuyenSelect.value = 'Không thuộc thẩm quyền';
        }

        // Hàm xuất dữ liệu ra Excel
        function exportToExcel() {
            const table = document.getElementById('don-body');
            if (!table || table.rows.length === 0) {
                alert('Không có dữ liệu để xuất.');
                return;
            }
            
            const tableRows = table.getElementsByTagName('tr');
            let data = [];
            
            // Thêm tiêu đề
            const headers = ['STT', 'Ngày nhận', 'Họ tên/Cơ quan/Tổ chức', 'Nội dung tóm tắt', 'Phân loại', 'Thẩm quyền', 'Kết quả'];
            data.push(headers);
            
            // Thêm dữ liệu từ bảng
            for (let i = 0; i < tableRows.length; i++) {
                const row = tableRows[i];
                const rowData = [];
                // Bỏ cột "Hành động" (cột cuối cùng)
                for (let j = 0; j < row.cells.length - 1; j++) {
                    rowData.push(row.cells[j].textContent);
                }
                data.push(rowData);
            }

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "DanhSachDon");
            XLSX.writeFile(wb, "QuanLyDonKhieuNaiToCao_" + new Date().toISOString().slice(0, 10) + ".xlsx");
        }

        // Xử lý sự kiện Enter để đăng nhập
        function setupEnterKeyListener() {
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        }

        // --- INITIALIZATION ---
        
        function init() {
            initializeDefaultAccounts(); 
            initSelectOptions();
            document.getElementById("ngay_nhan").value = new Date().toISOString().slice(0, 10);
            document.getElementById('new-role').onchange = capNhatDonViTheoVaiTro;
            capNhatDonViTheoVaiTro();
            
            // Khởi tạo fields căn cứ
            populateCanCuFields([], ''); 
            
            setupEnterKeyListener(); 
            
            // Ẩn nút quản lý TK khi chưa đăng nhập
            const accountBtn = document.getElementById('account-btn');
            if (accountBtn) {
                accountBtn.style.display = 'none'; 
            }
        }
        
        // Gọi hàm khởi tạo khi trang tải xong
        init();
        
    </script>
</body>
</html>
