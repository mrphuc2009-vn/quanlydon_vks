<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    
    <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self'; 
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; 
                 script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://*.googleapis.com https://*.firebaseio.com https://*.firebasedatabase.app https://*.jsdelivr.net; 
                 connect-src 'self' https://www.gstatic.com https://*.googleapis.com https://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebaseio.com wss://*.firebasedatabase.app https://*.jsdelivr.net;
                 img-src 'self' data: https://vienkiemsat.cantho.gov.vn https://upload.wikimedia.org blob:;">

    <title>Phần Mềm Quản Lý Đơn Khiếu nại - Tố Cáo</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    
    <style>
        
        body {
            font-family: 'Segoe UI', 'Times New Roman', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
        }

        header {
            width: 100%;
            padding: 20px;
            background-color: #004d40;
            color: white;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        
        #login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #E6F7FF; /* Xanh dương nhạt */
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            margin: auto;
            position: absolute;
            top: 55%; /* Tăng từ 50% lên 55% */
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #login-container h2 {
            margin-bottom: 20px;
            color: #D32F2F; /* Đỏ */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        #login-container input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        #login-container button {
            width: 100%;
            padding: 12px;
            background-color: #004d40;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        #login-container button:hover {
            background-color: #00332b;
        }

        #main-container {
            display: none;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            margin-top: 20px;
        }
        
        .main-content {
            display: flex;
            flex-direction: row;
            width: 100%;
            height: calc(100% - 60px);
            gap: 20px;
            padding: 0 20px;
        }
        
        .sidebar {
            flex: 1;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .main-panel {
            flex: 2;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
        }
        
        .sidebar button, .main-panel button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            color: white;
            background-color: #00796b;
            transition: background-color 0.3s;
        }

        .sidebar button:hover, .main-panel button:hover {
            background-color: #00605a;
        }
        
        .form-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-section.full-width {
            grid-template-columns: 1fr;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: span 2;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
            background-color: #f9f9f9;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .can-cu-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 2fr auto;
            gap: 10px;
            margin-bottom: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: #e0f2f1;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f5f5f5;
        }
        
        tr:hover {
            background-color: #e8f5e9;
        }
        
        .table-actions button {
            padding: 5px 10px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .table-actions td {
            white-space: nowrap;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

         .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 600px; 
            width: 90%;
            position: relative;
            max-height: 90vh; 
            overflow-y: auto; 
        }

      
        .modal-content.large-modal {
            max-width: 90%; 
            max-width: 1200px; 
        }
        
        
        #accountsModal .modal-content {
            max-width: 700px; 
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }
        
        .close-btn:hover, .close-btn:focus {
            color: #000;
        }
        
        .btn-container {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .delete-btn {
            background-color: #d32f2f !important;
        }
        
        .delete-btn:hover {
            background-color: #b71c1c !important;
        }
        
        .edit-btn {
            background-color: #1976d2 !important;
        }
        
        .edit-btn:hover {
            background-color: #1565c0 !important;
        }
        
        .xu-ly-btn {
            background-color: #00897b !important;
        }
        
        .export-proposal-btn {
            background-color: #3f51b5 !important;
        }
        
        .export-proposal-btn:hover {
            background-color: #303f9f !important;
        }
        
      
        #proposal-content {
            white-space: pre-wrap;
            font-family: 'Times New Roman', serif;
            font-size: 14pt; 
            line-height: 1.5;
        }
        
        #top-right-buttons {
            position: absolute;
            top: 10px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        #account-list li {
            list-style: none;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #account-list li button {
             margin-left: 10px;
             padding: 5px 10px;
             font-size: 12px;
             width: auto;
        }
        .reset-btn {
             background-color: #ff9800 !important;
        }
        .reset-btn:hover {
             background-color: #fb8c00 !important;
        }
    </style>
</head>
<body>
    <header>
        <h1>VIỆN KIỂM SÁT NHÂN DÂN THÀNH PHỐ CẦN THƠ</h1>
        <H2>QUẢN LÝ ĐƠN KHIẾU NẠI - TỐ CÁO</H2>
        <div id="top-right-buttons">
            <button id="account-btn" onclick="showAccountsModal()">Quản lý tài khoản</button>
            <button onclick="showChangePassModal()">Đổi mật khẩu</button> 
            <button onclick="logout()">Đăng xuất</button>
        </div>
    </header>

    <div id="login-container">
        <img src="https://vienkiemsat.cantho.gov.vn/files/images/logo-vks.png" 
             alt="Logo Viện Kiểm Sát" style="width: 100px; margin-bottom: 20px;">
        <h2>Đăng Nhập</h2>
        <input type="text" id="username" placeholder="Tên đăng nhập">
        <input type="password" id="password" placeholder="Mật khẩu">
        <button onclick="login()">Đăng Nhập</button>
        <p><a href="#" onclick="handleForgotPassword()">Quên mật khẩu?</a></p>
    </div>

    <div id="main-container">
        <div class="main-content">
            <div class="sidebar">
                <h2>Lưu đơn mới</h2>
                <div class="form-section">
                    <div class="form-group">
                        <label for="ngay_nhan">Ngày nhận đơn:</label>
                        <input type="date" id="ngay_nhan">
                    </div>
                    <div class="form-group">
                        <label for="nguon_don">Nguồn đơn:</label>
                        <select id="nguon_don"></select>
                    </div>
                </div>
                <div class="form-section full-width">
                    <div class="form-group">
                        <label for="ho_ten">Họ tên/Cơ quan/Tổ chức:</label>
                        <input type="text" id="ho_ten">
                    </div>
                    <div class="form-group">
                        <label for="dia_chi">Địa chỉ:</label>
                        <input type="text" id="dia_chi">
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-group">
                        <label for="ngay_ghi">Đơn ghi ngày:</label>
                        <input type="date" id="ngay_ghi">
                    </div>
                    <div class="form-group">
                        <label for="phan_loai">Phân loại:</label>
                        <select id="phan_loai" onchange="capNhatThamQuyenMacDinh()">
                            <option value="Khiếu nại">Khiếu nại</option>
                            <option value="Tố cáo">Tố cáo</option>
                            <option value="Kiến nghị/Phản ánh/Khác">Kiến nghị/Phản ánh/Khác</option>
                            <option value="Yêu cầu bồi thường thiệt hại">Yêu cầu bồi thường thiệt hại</option> 
                            <option value="Đề nghị KN, GĐT, TT">Đề nghị KN, GĐT, TT</option>
                            <option value="Đề nghị kiểm tra QĐGQKN">Đề nghị kiểm tra QĐGQKN</option>
                            <option value="Tin báo/Tố giác tội phạm trong HĐTP">Tin báo/Tố giác tội phạm trong HĐTP</option>
                        </select>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-group">
                        <label for="tham_quyen">Thẩm quyền:</label>
                        <select id="tham_quyen">
                            <option value="Chọn">--Chọn--</option>
                            <option value="Thuộc thẩm quyền giải quyết">Thuộc thẩm quyền giải quyết</option>
                            <option value="Thuộc thẩm quyền kiểm sát">Thuộc thẩm quyền kiểm sát</option>
                            <option value="Không thuộc thẩm quyền">Không thuộc thẩm quyền</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="can_bo_phan_cong">Cán bộ phân công:</label>
                        <input type="text" id="can_bo_phan_cong" readonly>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-group">
                        <label for="chuc_danh">Chức danh:</label>
                        <select id="chuc_danh">
                            <option value="Chọn">--Chọn--</option>
                            <option value="Kiểm sát viên trung cấp">Kiểm sát viên trung cấp</option>
                            <option value="Kiểm sát viên sơ cấp">Kiểm sát viên sơ cấp</option>
                            <option value="Kiểm tra viên chính">Kiểm tra viên chính</option>
                            <option value="Kiểm tra viên">Kiểm tra viên</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="chuyen_den">Chuyển đến:</label>
                        <select id="chuyen_den"></select>
                    </div>
                </div>
                <div class="form-section">
                     <div class="form-group">
                        <label for="ngay_chuyen_don">Ngày chuyển đơn:</label>
                        <input type="date" id="ngay_chuyen_don">
                    </div>
                </div>
                <div class="form-group full-width">
                    <label>Căn cứ:</label>
                    <div id="can_cu_container"></div>
                    <button onclick="addCanCu()">Thêm căn cứ</button>
                </div>
                <div class="form-group full-width">
                    <label for="noi_dung">Nội dung đơn:</label>
                    <textarea id="noi_dung"></textarea>
                </div>
                <div class="form-group full-width">
                    <label for="de_xuat">Đề xuất:</label>
                    <textarea id="de_xuat"></textarea>
                </div>
                <div class="form-group full-width">
                    <label for="ket_qua">Kết quả:</label>
                    <textarea id="ket_qua"></textarea>
                </div>
                <input type="hidden" id="edit-id">
                <button onclick="saveDon()">Lưu đơn</button>
            </div>

            <div class="main-panel">
                <h2>Danh sách đơn</h2>
                <div class="btn-container" style="justify-content: flex-start; margin-bottom: 20px;">
                    <button onclick="exportList()">Xuất Danh sách đơn</button>
                    <button onclick="exportReport()">Xuất báo cáo</button>
                    <button onclick="downloadJSON()">Sao lưu JSON</button>
                    <button class="export-btn" onclick="downloadResolutionResultDoc(currentSelectedId)">Trích xuất kết quả xử lý đơn</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Ngày nhận đơn</th>
                            <th>Họ tên /CQ/ TC</th>
                            <th>Nội dung đơn</th>
                            <th>Phân loại</th>
                            <th>Thẩm quyền</th>
                            <th>Xử lý đơn</th> 
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="don-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="accountsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('accountsModal').style.display='none'">&times;</span>
            <h3>Quản lý Tài khoản</h3>
            <h4>Tạo tài khoản mới</h4>
            <div class="form-section">
                <div class="form-group">
                    <label for="new-username">Tên đăng nhập:</label>
                    <input type="text" id="new-username">
                </div>
                <div class="form-group">
                    <label for="new-password">Mật khẩu:</label>
                    <input type="password" id="new-password">
                </div>
                <div class="form-group">
                    <label for="new-role">Vai trò:</label>
                    <select id="new-role">
                        <option value="admin">Quản trị viên (admin)</option>
                        <option value="super_admin">Quản trị viên cấp cao (super_admin)</option>
                        <option value="manager_TP">Quản lý cấp Thành phố</option>
                        <option value="user_TP">Người dùng cấp Thành phố</option>
                        <option value="manager_KV">Quản lý cấp Khu vực</option>
                        <option value="user_KV">Người dùng cấp Khu vực</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-unit">Đơn vị:</label>
                    <select id="new-unit"></select>
                </div>
            </div>
            <button onclick="createAccount()">Tạo tài khoản</button>
            <h4>Danh sách tài khoản</h4>
            <ul id="account-list"></ul>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content large-modal">
            <span class="close-btn" onclick="document.getElementById('editModal').style.display='none'">&times;</span>
            <h3>Sửa đổi đơn</h3>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-ngay_nhan">Ngày nhận đơn:</label>
                    <input type="date" id="sua-ngay_nhan">
                </div>
                <div class="form-group">
                    <label for="sua-nguon_don">Nguồn đơn:</label>
                    <select id="sua-nguon_don"></select>
                </div>
            </div>
            <div class="form-section full-width">
                <div class="form-group">
                    <label for="sua-ho_ten">Họ tên/Cơ quan/Tổ chức:</label>
                    <input type="text" id="sua-ho_ten">
                </div>
                <div class="form-group">
                    <label for="sua-dia_chi">Địa chỉ:</label>
                    <input type="text" id="sua-dia_chi">
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-ngay_ghi">Đơn ghi ngày:</label>
                    <input type="date" id="sua-ngay_ghi">
                </div>
                <div class="form-group">
                    <label for="sua-phan_loai">Phân loại:</label>
                    <select id="sua-phan_loai" onchange="capNhatThamQuyenMacDinh('sua-')">
                            <option value="Chọn">--Chọn--</option>
                            <option value="Khiếu nại">Khiếu nại</option>
                            <option value="Tố cáo">Tố cáo</option>
                            <option value="Kiến nghị/Phản ánh/Khác">Kiến nghị/Phản ánh/Khác</option>
                            <option value="Yêu cầu bồi thường thiệt hại">Yêu cầu bồi thường thiệt hại</option> 
                            <option value="Đề nghị KN, GĐT, TT">Đề nghị KN, GĐT, TT</option>
                            <option value="Đề nghị kiểm tra QĐGQKN">Đề nghị kiểm tra QĐGQKN</option>
                            <option value="Tin báo/Tố giác tội phạm trong HĐTP">Tin báo/Tố giác tội phạm trong HĐTP</option>
                    </select>
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-tham_quyen">Thẩm quyền:</label>
                    <select id="sua-tham_quyen">
                        <option value="Chọn">--Chọn--</option>
                        <option value="Thuộc thẩm quyền giải quyết">Thuộc thẩm quyền giải quyết</option>
                        <option value="Thuộc thẩm quyền kiểm sát">Thuộc thẩm quyền kiểm sát</option>
                        <option value="Không thuộc thẩm quyền">Không thuộc thẩm quyền</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sua-can_bo_phan_cong">Cán bộ phân công:</label>
                    <input type="text" id="sua-can_bo_phan_cong">
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-chuc_danh">Chức danh:</label>
                    <select id="sua-chuc_danh">
                        <option value="Chọn">--Chọn--</option>
                        <option value="Kiểm sát viên trung cấp">Kiểm sát viên trung cấp</option>
                        <option value="Kiểm sát viên sơ cấp">Kiểm sát viên sơ cấp</option>
                        <option value="Kiểm tra viên chính">Kiểm tra viên chính</option>
                        <option value="Kiểm tra viên">Kiểm tra viên</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sua-chuyen_den">Chuyển đến:</label>
                    <select id="sua-chuyen_den"></select>
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-ngay_chuyen_don">Ngày chuyển đơn:</label>
                    <input type="date" id="sua-ngay_chuyen_don">
                </div>
            </div>
             <div class="form-group full-width">
                <label>Căn cứ:</label>
                <div id="sua-can_cu_container"></div>
                <button onclick="addCanCu('sua-')">Thêm căn cứ</button>
            </div>
            <div class="form-group full-width">
                <label for="sua-noi_dung">Nội dung đơn:</label>
                <textarea id="sua-noi_dung"></textarea>
            </div>
            <div class="form-group full-width">
                <label for="sua-de_xuat">Đề xuất:</label>
                <textarea id="sua-de_xuat"></textarea>
            </div>
            <div class="form-group full-width">
                <label for="sua-ket_qua">Kết quả:</label>
                <textarea id="sua-ket_qua"></textarea>
            </div>
            <input type="hidden" id="edit-id-modal"> 
            <div class="btn-container">
                <button onclick="updateDon()">Cập nhật</button>
            </div>
        </div>
    </div>
    
    <div id="proposalModal" class="modal">
        <div class="modal-content large-modal">
            <span class="close-btn" onclick="document.getElementById('proposalModal').style.display='none'">&times;</span>
            <pre id="proposal-content"></pre>
            <div class="btn-container">
                <button onclick="downloadProposalDoc()">Tải xuống file word</button>
            </div>
        </div>
    </div>

    <div id="changePassModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('changePassModal').style.display='none'">&times;</span>
            <h3>Đổi mật khẩu</h3>
            <div class="form-group">
                <label for="old-password">Mật khẩu cũ:</label>
                <input type="password" id="old-password">
            </div>
            <div class="form-group">
                <label for="new-password-change">Mật khẩu mới:</label>
                <input type="password" id="new-password-change">
            </div>
            <div class="form-group">
                <label for="confirm-password-change">Xác nhận mật khẩu mới:</label>
                <input type="password" id="confirm-password-change">
            </div>
            <div class="btn-container">
                <button onclick="changePassword()">Xác nhận</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE CONFIGURATION & INITIALIZATION (PHẢI THAY THẾ) ---
        // THAY THẾ CHỖ NÀY BẰNG CẤU HÌNH CỦA BẠN
        const firebaseConfig = {
            apiKey: "AIzaSyBvhrOBoJc9-gKuTAXDlPknVdxKecgPH_g",
            authDomain: "quanlydonvks-d7ff9.firebaseapp.com",
            databaseURL: "https://quanlydonvks-d7ff9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "quanlydonvks-d7ff9",
            storageBucket: "quanlydonvks-d7ff9.firebasestorage.app",
            messagingSenderId: "209768483000",
            appId: "1:209768483000:web:1eb449ad41840e23334c4d"
        };
        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- GLOBAL DATA & INITIALIZATION ---
        let accounts = {}; // Dữ liệu tài khoản (tải từ Firebase)
        let dons = []; // Dữ liệu đơn (tải từ Firebase dưới dạng mảng để dễ xử lý)
        let currentUser = null; 
        let currentSelectedId = null; // Biến lưu ID đơn đang được chọn để trích xuất

        // Dữ liệu danh mục
        const lookupData = {
            'Nguồn đơn': [
                'Bưu điện', 'Tiếp công dân', 'Các cơ quan Đảng, Nhà nước', 'UBND TPCT', 'Cục Điều tra, VKSTC', 'V11, VKSTC', 'V12, VKSTC', 'Các Sở, Ban, Ngành', 'Thành ủy'
            ],
            'Chuyển đến': [
                'Lưu đơn', 'Trả đơn', 'Thông báo chỉ dẫn', 'THADS TP.CT', 'THADS KV1','THADS KV2','THADS KV3','THADS KV4','THADS KV5','THADS KV6','THADS KV7', 'THADS KV8','THADS KV9','THADS KV10','THADS KV11','THADS KV12','THADS KV13','THADS KV14', 'TAND TP.CT', 'TAND KV1', 'TAND KV2','TAND KV3','TAND KV4','TAND KV5','TAND KV6','TAND KV7', 'TAND KV8','TAND KV9','TAND KV10','TAND KV11','TAND KV12','TAND KV13','TAND KV14', 'CQCSĐT TP.CT', 'Công an phường', 'VKSND KV1', 'VKSND KV2', 'VKSND KV3', 'VKSND KV4', 'VKSND KV5', 'VKSND KV6', 'VKSND KV7', 'VKSND KV8', 'VKSND KV9', 'VKSND KV10', 'VKSND KV11', 'VKSND KV12', 'VKSND KV13', 'VKSND KV14', 'Phòng 1', 'Phòng 2', 'Phòng 7', 'Phòng 8', 'Phòng 9', 'Phòng 10', 'Phòng 11', 'Phòng 15'
            ],
            'Đơn vị': [
                'TT-KT', 'VKSND KV1', 'VKSND KV2', 'VKSND KV3', 'VKSND KV4', 'VKSND KV5', 'VKSND KV6', 'VKSND KV7', 'VKSND KV8', 'VKSND KV9', 'VKSND KV10', 'VKSND KV11', 'VKSND KV12', 'VKSND KV13', 'VKSND KV14', 'TP-KT'
            ]
        };

        // --- AUTHENTICATION FUNCTIONS --- 
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Kiểm tra và lấy tài khoản đang đăng nhập
            database.ref('accounts').once('value')
                .then(snapshot => {
                    const allAccounts = snapshot.val() || {};
                    accounts = allAccounts; // Cập nhật danh sách tài khoản toàn cục
                    
                    if (allAccounts[username] && allAccounts[username].password === password) {
                        const user = allAccounts[username];
                        currentUser = { 
                            username: username, 
                            role: user.role, 
                            unit: user.unit // Lấy đơn vị của người dùng
                        }; 
                        
                        document.getElementById('login-container').style.display = 'none';
                        document.getElementById('main-container').style.display = 'flex';
                        
                        // Hiển thị tên đăng nhập vào ô cán bộ phân công
                        document.getElementById('can_bo_phan_cong').value = currentUser.username; 
                        
                        // Phân quyền hiển thị Quản lý tài khoản
                        if (currentUser.role === 'admin' || currentUser.role === 'super_admin') {
                            document.getElementById('account-btn').style.display = 'block';
                        } else {
                            document.getElementById('account-btn').style.display = 'none';
                        }
                        
                        // Bắt đầu tải dữ liệu đơn đã được lọc
                        updateTable(); 
                    } else {
                        alert('Tên đăng nhập hoặc mật khẩu không đúng!');
                    }
                })
                .catch(error => {
                    alert('Lỗi khi đăng nhập: ' + error.message);
                });
        }

        function logout() {
            currentUser = null;
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('main-container').style.display = 'none';
            document.getElementById('account-btn').style.display = 'none';
            // Xóa hết dữ liệu bảng khi đăng xuất
            document.getElementById('don-body').innerHTML = ''; 
        }

        // Các hàm quản lý tài khoản, đổi mật khẩu (Giữ nguyên)
        function showChangePassModal() { /* ... code ... */ }
        function changePassword() { /* ... code ... */ }
        function handleForgotPassword() { /* ... code ... */ }
        function initializeDefaultAccounts() { /* ... code ... */ }
        function capNhatDonViTheoVaiTro() { /* ... code ... */ }
        function showAccountsModal() { /* ... code ... */ }
        function displayAccounts() { /* ... code ... */ }
        function createAccount() { /* ... code ... */ }
        function deleteAccount(username) { /* ... code ... */ }
        function resetPassword(username) { /* ... code ... */ }
        
        // --- DATA INPUT/OUTPUT UTILITIES ---
        function initSelectOptions() { /* ... code ... */ }
        function capNhatThamQuyenMacDinh(prefix = '') { /* ... code ... */ }
        function getCanCuData(prefix = '') { /* ... code ... */ }
        function populateCanCuFields(canCuArray, prefix = '') { /* ... code ... */ }
        function addCanCu(prefix = '') { /* ... code ... */ }
        function removeCanCu(element) { /* ... code ... */ }
        function displayDonList(list) { /* ... code ... */ }
        function formatCanCu(canCuArray) { /* ... code ... */ }
        function exportList() { /* ... code ... */ }
        function exportReport() { /* ... code ... */ }
        function downloadJSON() { /* ... code ... */ }
        function generateResolutionResultDoc(don) { /* ... code ... */ }
        function downloadResolutionResultDoc(donId) { /* ... code ... */ }
        function generateProposalContent(don) { /* ... code ... */ }
        function showProposal(donId) { /* ... code ... */ }
        function downloadProposalDoc() { /* ... code ... */ }
        
        // --- FIREBASE DATA FUNCTIONS (CÓ CHỈNH SỬA) ---

        /**
         * HÀM QUAN TRỌNG: Tải và lọc dữ liệu đơn dựa trên vai trò người dùng.
         */
        function updateTable() {
            if (!currentUser) return;

            const donRef = database.ref('don');
            let query;

            if (currentUser.role === 'admin' || currentUser.role === 'super_admin') {
                // 1. Tài khoản 'super_admin' hoặc 'admin': Tải TẤT CẢ dữ liệu
                query = donRef; 
                console.log("Admin/Super_Admin: Tải toàn bộ dữ liệu.");
            } else if (currentUser.unit) {
                // 2. Tài khoản con: Chỉ tải dữ liệu của đơn vị mình.
                // Lọc theo trường 'don_vi_xu_ly'
                query = donRef.orderByChild('don_vi_xu_ly').equalTo(currentUser.unit);
                console.log(`Tài khoản ${currentUser.username} (${currentUser.role}) đang tải dữ liệu lọc theo đơn vị: ${currentUser.unit}`);
            } else {
                // Trường hợp tài khoản con nhưng thiếu thông tin đơn vị (lý thuyết không xảy ra)
                console.error("Lỗi phân quyền: Không tìm thấy đơn vị của tài khoản.");
                document.getElementById('don-body').innerHTML = '<tr><td colspan="8">Không thể tải dữ liệu. Tài khoản thiếu thông tin đơn vị.</td></tr>';
                return;
            }

            // Thực hiện lắng nghe dữ liệu
            query.on('value', (snapshot) => {
                const donList = [];
                snapshot.forEach((childSnapshot) => {
                    const don = childSnapshot.val();
                    don.id = childSnapshot.key;
                    donList.push(don);
                });

                dons = donList; // Cập nhật biến toàn cục
                displayDonList(dons); // Hiển thị dữ liệu lên bảng
            }, (error) => {
                console.error("Lỗi khi tải dữ liệu đơn: ", error);
                document.getElementById('don-body').innerHTML = `<tr><td colspan="8">Lỗi khi tải dữ liệu: ${error.message}</td></tr>`;
            });
        }

        /**
         * HÀM QUAN TRỌNG: Lưu đơn mới/Chỉnh sửa đơn.
         * Đảm bảo lưu trường 'don_vi_xu_ly'
         */
        function saveDon() {
            if (!currentUser) {
                alert('Vui lòng đăng nhập trước.');
                return;
            }
            const id = document.getElementById('edit-id').value;
            const canCuArray = getCanCuData(); 
            const ngayNhan = document.getElementById('ngay_nhan').value;
            const hoTen = document.getElementById('ho_ten').value;

            if (!ngayNhan || !hoTen) {
                alert('Vui lòng nhập đầy đủ Ngày nhận đơn và Họ tên/Cơ quan/Tổ chức.');
                return;
            }

            const donData = {
                ngay_nhan: ngayNhan,
                nguon_don: document.getElementById('nguon_don').value,
                ho_ten: hoTen,
                dia_chi: document.getElementById('dia_chi').value,
                ngay_ghi: document.getElementById('ngay_ghi').value,
                phan_loai: document.getElementById('phan_loai').value,
                tham_quyen: document.getElementById('tham_quyen').value,
                can_bo_phan_cong: document.getElementById('can_bo_phan_cong').value,
                chuc_danh: document.getElementById('chuc_danh').value,
                chuyen_den: document.getElementById('chuyen_den').value,
                ngay_chuyen_don: document.getElementById('ngay_chuyen_don').value,
                noi_dung: document.getElementById('noi_dung').value,
                de_xuat: document.getElementById('de_xuat').value,
                ket_qua: document.getElementById('ket_qua').value,
                can_cu: canCuArray,
                // THÊM TRƯỜNG PHÂN QUYỀN VÀO ĐÂY
                don_vi_xu_ly: currentUser.unit, 
            };

            if (id) {
                // Chỉnh sửa đơn
                database.ref('don/' + id).update(donData)
                    .then(() => {
                        alert('Cập nhật đơn thành công!');
                        clearForm();
                    })
                    .catch(error => {
                        alert('Lỗi khi cập nhật đơn: ' + error.message);
                    });
            } else {
                // Lưu đơn mới
                database.ref('don').push(donData)
                    .then(() => {
                        alert('Lưu đơn thành công!');
                        clearForm();
                    })
                    .catch(error => {
                        alert('Lỗi khi lưu đơn: ' + error.message);
                    });
            }
        }

        function clearForm() {
            // Xóa nội dung form nhập liệu
            document.getElementById('edit-id').value = '';
            document.getElementById('ngay_nhan').value = new Date().toISOString().slice(0, 10);
            document.getElementById('nguon_don').value = '';
            document.getElementById('ho_ten').value = '';
            document.getElementById('dia_chi').value = '';
            document.getElementById('ngay_ghi').value = '';
            document.getElementById('phan_loai').value = 'Khiếu nại';
            document.getElementById('tham_quyen').value = 'Chọn';
            document.getElementById('can_bo_phan_cong').value = currentUser ? currentUser.username : ''; // Giữ lại tên đăng nhập
            document.getElementById('chuc_danh').value = 'Chọn';
            document.getElementById('chuyen_den').value = '';
            document.getElementById('ngay_chuyen_don').value = '';
            document.getElementById('noi_dung').value = '';
            document.getElementById('de_xuat').value = '';
            document.getElementById('ket_qua').value = '';
            
            // Xóa căn cứ và thêm lại một dòng trống
            populateCanCuFields([], ''); 
            
            capNhatThamQuyenMacDinh();
        }

        function editDon(id) {
            const don = dons.find(d => d.id === id);
            if (!don) {
                alert('Không tìm thấy đơn để chỉnh sửa.');
                return;
            }
            
            // Đổ dữ liệu vào Modal sửa đổi
            document.getElementById('sua-ngay_nhan').value = don.ngay_nhan || '';
            document.getElementById('sua-nguon_don').value = don.nguon_don || '';
            document.getElementById('sua-ho_ten').value = don.ho_ten || '';
            document.getElementById('sua-dia_chi').value = don.dia_chi || '';
            document.getElementById('sua-ngay_ghi').value = don.ngay_ghi || '';
            document.getElementById('sua-phan_loai').value = don.phan_loai || 'Chọn';
            document.getElementById('sua-tham_quyen').value = don.tham_quyen || 'Chọn';
            document.getElementById('sua-can_bo_phan_cong').value = don.can_bo_phan_cong || '';
            document.getElementById('sua-chuc_danh').value = don.chuc_danh || 'Chọn';
            document.getElementById('sua-chuyen_den').value = don.chuyen_den || ''; 
            document.getElementById('sua-ngay_chuyen_don').value = don.ngay_chuyen_don || '';
            populateCanCuFields(don.can_cu, 'sua-');
            document.getElementById('sua-noi_dung').value = don.noi_dung || '';
            document.getElementById('sua-de_xuat').value = don.de_xuat || '';
            document.getElementById('sua-ket_qua').value = don.ket_qua || '';
            
            document.getElementById('editModal').style.display = 'flex';

            let editIdModal = document.getElementById('edit-id-modal');
            if (!editIdModal) {
                editIdModal = document.createElement('input');
                editIdModal.type = 'hidden';
                editIdModal.id = 'edit-id-modal';
                document.querySelector('.modal-content.large-modal').appendChild(editIdModal);
            }
            editIdModal.value = id;
        }


        function updateDon() {
            if (!currentUser) {
                alert('Vui lòng đăng nhập trước.');
                return;
            }
            const id = document.getElementById('edit-id-modal').value;
            const canCuArray = getCanCuData('sua-'); 

            if (!id) {
                alert('Lỗi: Không tìm thấy ID đơn để cập nhật.');
                return;
            }

            const donData = {
                ngay_nhan: document.getElementById('sua-ngay_nhan').value,
                nguon_don: document.getElementById('sua-nguon_don').value,
                ho_ten: document.getElementById('sua-ho_ten').value,
                dia_chi: document.getElementById('sua-dia_chi').value,
                ngay_ghi: document.getElementById('sua-ngay_ghi').value,
                phan_loai: document.getElementById('sua-phan_loai').value,
                tham_quyen: document.getElementById('sua-tham_quyen').value,
                can_bo_phan_cong: document.getElementById('sua-can_bo_phan_cong').value,
                chuc_danh: document.getElementById('sua-chuc_danh').value,
                chuyen_den: document.getElementById('sua-chuyen_den').value,
                ngay_chuyen_don: document.getElementById('sua-ngay_chuyen_don').value,
                noi_dung: document.getElementById('sua-noi_dung').value,
                de_xuat: document.getElementById('sua-de_xuat').value,
                ket_qua: document.getElementById('sua-ket_qua').value,
                can_cu: canCuArray,
                // Đảm bảo trường phân quyền được giữ lại hoặc cập nhật (Tốt nhất là giữ lại unit của người đã nhập ban đầu)
                // Tuy nhiên, để đảm bảo người sửa có thể thấy đơn sau khi sửa, 
                // ta sẽ chỉ cập nhật trường này nếu nó chưa tồn tại. 
                // Trong trường hợp này, ta giả định unit không đổi sau khi đơn được nhập.
                // Để đơn giản và đảm bảo tính năng phân quyền: ta sẽ không sửa trường này.
                // Nếu muốn sửa, cần phải có logic phức tạp hơn.
                // Tốt nhất, ta sẽ giữ lại giá trị cũ của don_vi_xu_ly.
            };

            // Lấy đơn vị hiện tại của đơn để đảm bảo không bị ghi đè nếu nó đã được lưu
            const existingDon = dons.find(d => d.id === id);
            if (existingDon && existingDon.don_vi_xu_ly) {
                donData.don_vi_xu_ly = existingDon.don_vi_xu_ly;
            } else {
                 donData.don_vi_xu_ly = currentUser.unit;
            }

            database.ref('don/' + id).update(donData)
                .then(() => {
                    alert('Cập nhật đơn thành công!');
                    document.getElementById('editModal').style.display = 'none';
                })
                .catch(error => {
                    alert('Lỗi khi cập nhật đơn: ' + error.message);
                });
        }

        function deleteDon(id) { /* ... code ... */ }

        // --- Hàm khác (Giữ nguyên) ---

        function showAccountsModal() {
             if (currentUser.role === 'admin' || currentUser.role === 'super_admin') {
                displayAccounts();
                document.getElementById('accountsModal').style.display = 'flex';
            } else {
                alert('Bạn không có quyền quản lý tài khoản.');
            }
        }
        
        function deleteDon(id) {
            if (confirm('Bạn có chắc chắn muốn xóa đơn này không?')) {
                database.ref('don/' + id).remove()
                    .then(() => {
                        alert('Xóa đơn thành công!');
                    })
                    .catch(error => {
                        alert('Lỗi khi xóa đơn: ' + error.message);
                    });
            }
        }
        
        // --- CÁC HÀM KHÁC DƯỚI ĐÂY ĐƯỢC GIỮ NGUYÊN (NHƯNG CẦN ĐỊNH NGHĨA LẠI ĐỂ CHẠY) ---
        // (Do tôi không có toàn bộ code gốc, tôi sẽ chèn phần định nghĩa cho các hàm cần thiết để cấu trúc chạy được)
        
        function showChangePassModal() { 
            if (!currentUser) { alert('Vui lòng đăng nhập trước.'); return; } 
            document.getElementById('old-password').value = ''; 
            document.getElementById('new-password-change').value = ''; 
            document.getElementById('confirm-password-change').value = ''; 
            document.getElementById('changePassModal').style.display = 'flex'; 
        } 
        
        function changePassword() { 
            const oldPass = document.getElementById('old-password').value; 
            const newPass = document.getElementById('new-password-change').value; 
            const confirmPass = document.getElementById('confirm-password-change').value; 
            if (!currentUser) return alert('Vui lòng đăng nhập trước.'); 
            database.ref('accounts/' + currentUser.username).once('value').then(snap => { 
                const currentAccount = snap.val(); 
                if (!currentAccount) return alert('Lỗi: Không tìm thấy thông tin tài khoản.'); 
                if (oldPass === currentAccount.password) { 
                    if (newPass === confirmPass) { 
                        if (newPass.length < 3) { alert('Mật khẩu mới phải có ít nhất 3 ký tự.'); return; } 
                        database.ref('accounts/' + currentUser.username + '/password').set(newPass) 
                            .then(() => { alert('Mật khẩu đã được thay đổi thành công!'); document.getElementById('changePassModal').style.display = 'none'; accounts[currentUser.username].password = newPass; })
                            .catch(error => { alert('Lỗi khi đổi mật khẩu: ' + error.message); }); 
                    } else { alert('Mật khẩu mới không khớp.'); } 
                } else { alert('Mật khẩu cũ không đúng.'); } 
            }).catch(error => { alert('Lỗi khi kiểm tra mật khẩu: ' + error.message); }); 
        } 
        
        function handleForgotPassword() { 
            const username = prompt('Vui lòng nhập tên đăng nhập của bạn:'); 
            if (!username) return; 
            database.ref('accounts/' + username).once('value') 
                .then(snapshot => { 
                    if (snapshot.exists()) { 
                        if (confirm('Hệ thống sẽ đặt lại mật khẩu của bạn về "123". Vui lòng đăng nhập và đổi lại mật khẩu.')) { 
                            database.ref('accounts/' + username + '/password').set('123') 
                                .then(() => { alert('Đã đặt lại mật khẩu thành công!'); })
                                .catch(error => { alert('Lỗi khi đặt lại mật khẩu: ' + error.message); }); 
                        } 
                    } else { alert('Tên đăng nhập không tồn tại.'); } 
                })
                .catch(error => { alert('Lỗi khi kiểm tra tài khoản: ' + error.message); }); 
        } 

        function initializeDefaultAccounts() { 
            // Giữ nguyên đoạn code initializeDefaultAccounts() ban đầu của bạn 
            database.ref('accounts').once('value').then(snapshot => { 
                if (!snapshot.exists()) { 
                    const defaultAccounts = { 
                        "adminct": { "password": "123", "role": "admin", "unit": "TT-KT" }, 
                        "quanlyTP": { "password": "123", "role": "manager_TP", "unit": "TT-KT" }, 
                        "userKV1": { "password": "123", "role": "user_KV", "unit": "VKSND KV1" } 
                        // Bạn có thể thêm các tài khoản mặc định khác nếu cần
                    };
                    database.ref('accounts').set(defaultAccounts) 
                        .then(() => console.log('Tạo tài khoản mặc định thành công.'))
                        .catch(error => console.error('Lỗi khi tạo tài khoản mặc định:', error)); 
                } 
            }); 
        }

        function capNhatDonViTheoVaiTro() {
             const role = document.getElementById('new-role').value;
             const unitSelect = document.getElementById('new-unit');
             unitSelect.innerHTML = ''; // Xóa hết options cũ

             let availableUnits = lookupData['Đơn vị'];
             
             // Lọc danh sách đơn vị nếu cần thiết theo vai trò (tùy chỉnh nếu bạn có logic lọc)
             // Ví dụ: manager_TP chỉ được chọn TT-KT
             if (role === 'admin' || role === 'super_admin' || role === 'manager_TP' || role === 'user_TP') {
                // Cho phép chọn tất cả các đơn vị
                availableUnits.forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit;
                    option.textContent = unit;
                    unitSelect.appendChild(option);
                });
             } else {
                 // manager_KV, user_KV chỉ chọn đơn vị Khu vực (VKSND KV...)
                 availableUnits.filter(unit => unit.startsWith('VKSND KV')).forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit;
                    option.textContent = unit;
                    unitSelect.appendChild(option);
                 });
             }
        }

        function displayAccounts() {
            database.ref('accounts').once('value').then(snapshot => {
                accounts = snapshot.val() || {};
                const list = document.getElementById('account-list');
                list.innerHTML = '';

                for (const [username, user] of Object.entries(accounts)) {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <span>
                            <strong>${username}</strong> 
                            (${user.role} - ${user.unit})
                            ${username === currentUser.username ? ' (Tài khoản đang dùng)' : ''}
                        </span>
                        <div>
                            <button class="reset-btn" onclick="resetPassword('${username}')">Reset Mật khẩu</button>
                            ${username !== currentUser.username ? `<button class="delete-btn" onclick="deleteAccount('${username}')">Xóa</button>` : ''}
                        </div>
                    `;
                    list.appendChild(listItem);
                }
            });
        }

        function createAccount() {
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;
            const unit = document.getElementById('new-unit').value;

            if (!username || !password || !role || !unit) {
                alert('Vui lòng điền đầy đủ Tên đăng nhập, Mật khẩu, Vai trò và Đơn vị.');
                return;
            }

            if (accounts[username]) {
                alert('Tên đăng nhập đã tồn tại!');
                return;
            }

            if (password.length < 3) {
                 alert('Mật khẩu phải có ít nhất 3 ký tự.');
                 return;
            }

            database.ref('accounts/' + username).set({
                password: password,
                role: role,
                unit: unit
            })
            .then(() => {
                alert('Tạo tài khoản thành công!');
                document.getElementById('new-username').value = '';
                document.getElementById('new-password').value = '';
                displayAccounts();
            })
            .catch(error => {
                alert('Lỗi khi tạo tài khoản: ' + error.message);
            });
        }

        function deleteAccount(username) {
            if (confirm(`Bạn có chắc chắn muốn xóa tài khoản "${username}" không?`)) {
                 database.ref('accounts/' + username).remove()
                    .then(() => {
                        alert('Xóa tài khoản thành công!');
                        displayAccounts();
                    })
                    .catch(error => {
                        alert('Lỗi khi xóa tài khoản: ' + error.message);
                    });
            }
        }

        function resetPassword(username) {
            if (confirm(`Bạn có chắc chắn muốn đặt lại mật khẩu tài khoản "${username}" về "123" không?`)) {
                 database.ref('accounts/' + username + '/password').set('123')
                    .then(() => {
                        alert(`Đã đặt lại mật khẩu cho tài khoản "${username}" thành công!`);
                    })
                    .catch(error => {
                        alert('Lỗi khi reset mật khẩu: ' + error.message);
                    });
            }
        }
        
        // --- DATA INPUT/OUTPUT UTILITIES ---
        function initSelectOptions() { 
            // Nguồn đơn
            const nguonDonSelect = document.getElementById('nguon_don');
            nguonDonSelect.innerHTML = '<option value="">--Chọn--</option>';
            lookupData['Nguồn đơn'].forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                nguonDonSelect.appendChild(option);
                
                // Thêm vào modal sửa
                const optionSua = option.cloneNode(true);
                document.getElementById('sua-nguon_don').appendChild(optionSua);
            });
            
            // Chuyển đến
            const chuyenDenSelect = document.getElementById('chuyen_den');
            chuyenDenSelect.innerHTML = '<option value="">--Chọn--</option>';
            lookupData['Chuyển đến'].forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                chuyenDenSelect.appendChild(option);

                // Thêm vào modal sửa
                const optionSua = option.cloneNode(true);
                document.getElementById('sua-chuyen_den').appendChild(optionSua);
            });

             // Đơn vị (cho tạo tài khoản mới)
             const newUnitSelect = document.getElementById('new-unit');
             newUnitSelect.innerHTML = '';
             lookupData['Đơn vị'].forEach(unit => {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = unit;
                newUnitSelect.appendChild(option);
             });

        }

        function capNhatThamQuyenMacDinh(prefix = '') { 
            const phanLoai = document.getElementById(prefix + 'phan_loai').value;
            const thamQuyenSelect = document.getElementById(prefix + 'tham_quyen');

            if (phanLoai === 'Khiếu nại' || phanLoai === 'Tố cáo' || phanLoai === 'Yêu cầu bồi thường thiệt hại') {
                thamQuyenSelect.value = 'Thuộc thẩm quyền kiểm sát';
            } else if (phanLoai === 'Đề nghị KN, GĐT, TT' || phanLoai === 'Đề nghị kiểm tra QĐGQKN' || phanLoai === 'Tin báo/Tố giác tội phạm trong HĐTP') {
                thamQuyenSelect.value = 'Thuộc thẩm quyền giải quyết';
            } else {
                thamQuyenSelect.value = 'Chọn';
            }
        }

        function getCanCuData(prefix = '') { 
            const container = document.getElementById(prefix + 'can_cu_container');
            const items = container.querySelectorAll('.can-cu-item');
            const canCuArray = [];
            items.forEach(item => {
                const diem = item.querySelector('input[placeholder="Điểm"]').value;
                const khoan = item.querySelector('input[placeholder="Khoản"]').value;
                const dieu = item.querySelector('input[placeholder="Điều"]').value;
                const vanBan = item.querySelector('input[placeholder="Tên văn bản"]').value;
                
                if (diem || khoan || dieu || vanBan) {
                    canCuArray.push({ diem, khoan, dieu, vanBan });
                }
            });
            return canCuArray;
        }

        function populateCanCuFields(canCuArray, prefix = '') { 
            const container = document.getElementById(prefix + 'can_cu_container');
            container.innerHTML = ''; // Xóa hết nội dung cũ

            if (canCuArray && canCuArray.length > 0) {
                canCuArray.forEach(canCu => {
                    container.appendChild(createCanCuItem(canCu, prefix));
                });
            } else {
                // Đảm bảo luôn có ít nhất một dòng trống khi form mới
                container.appendChild(createCanCuItem({}, prefix));
            }
        }
        
        function createCanCuItem(canCu, prefix = '') {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'can-cu-item';
            itemDiv.innerHTML = `
                <input type="text" placeholder="Điểm" value="${canCu.diem || ''}">
                <input type="text" placeholder="Khoản" value="${canCu.khoan || ''}">
                <input type="text" placeholder="Điều" value="${canCu.dieu || ''}">
                <input type="text" placeholder="Tên văn bản" value="${canCu.vanBan || ''}">
                <button onclick="removeCanCu(this)" style="background-color: #f44336; width: 30px; padding: 5px;">-</button>
            `;
            return itemDiv;
        }

        function addCanCu(prefix = '') { 
            const container = document.getElementById(prefix + 'can_cu_container');
            container.appendChild(createCanCuItem({}, prefix));
        }

        function removeCanCu(button) { 
            button.parentElement.remove();
        }

        function displayDonList(list) {
            const tbody = document.getElementById('don-body');
            tbody.innerHTML = '';
            
            if (list.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="8">Không có dữ liệu đơn nào.</td></tr>';
                 return;
            }

            list.forEach((don, index) => {
                const row = tbody.insertRow();
                const canCuText = formatCanCu(don.can_cu);
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${don.ngay_nhan || ''}</td>
                    <td>${don.ho_ten || ''}</td>
                    <td>${don.noi_dung ? don.noi_dung.substring(0, 50) + '...' : ''}</td>
                    <td>${don.phan_loai || ''}</td>
                    <td>${don.tham_quyen || ''}</td>
                    <td>${don.chuyen_den || ''}</td>
                    <td class="table-actions">
                        <button class="edit-btn" onclick="editDon('${don.id}')">Sửa</button>
                        <button class="delete-btn" onclick="deleteDon('${don.id}')">Xóa</button>
                        <button class="xu-ly-btn" onclick="showProposal('${don.id}')">Đề xuất xử lý</button>
                        <button class="export-proposal-btn" onclick="downloadResolutionResultDoc('${don.id}')">Trích xuất KQ</button>
                    </td>
                `;
            });
        }

        function formatCanCu(canCuArray) { 
            if (!canCuArray || canCuArray.length === 0) return '';
            return canCuArray.map(c => 
                `${c.diem ? 'đ.' + c.diem : ''} ${c.khoan ? 'k.' + c.khoan : ''} ${c.dieu ? 'Đ.' + c.dieu : ''} ${c.vanBan || ''}`.trim()
            ).join('; ');
        }
        
        function exportList() { /* ... code ... */ }
        function exportReport() { /* ... code ... */ }
        function downloadJSON() { /* ... code ... */ }
        function generateResolutionResultDoc(don) { /* ... code ... */ }
        function downloadResolutionResultDoc(donId) { /* ... code ... */ }
        function generateProposalContent(don) { /* ... code ... */ }
        function showProposal(donId) { /* ... code ... */ }
        function downloadProposalDoc() { /* ... code ... */ }

        // --- KHỞI TẠO ---
        function init() {
            initializeDefaultAccounts(); // Đảm bảo có tài khoản mặc định
            initSelectOptions();
            document.getElementById("ngay_nhan").value = new Date().toISOString().slice(0, 10);
            document.getElementById('new-role').onchange = capNhatDonViTheoVaiTro;
            capNhatDonViTheoVaiTro();
            populateCanCuFields([], '');
            populateCanCuFields([], 'sua-');
            
            // Xử lý sự kiện modal đóng
            window.onclick = function(event) {
                if (event.target.id === 'accountsModal') {
                    event.target.style.display = 'none';
                }
                if (event.target.id === 'editModal') {
                    event.target.style.display = 'none';
                }
                if (event.target.id === 'proposalModal') {
                    event.target.style.display = 'none';
                }
                if (event.target.id === 'changePassModal') {
                    event.target.style.display = 'none';
                }
            }
        }
        
        // Gọi hàm khởi tạo khi trang tải xong
        window.onload = init;
    </script>
</body>
</html>
